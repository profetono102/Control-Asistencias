<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Colegio Xochicalli - Control Escolar QR</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-green: #0e5b2f;
            --accent-orange: #e96925;
        }

        @page {
            size: letter;
            margin: 0;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; visibility: visible !important; }
            
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 215.9mm; 
                height: 279.4mm; 
                z-index: 9999; 
                background: white;
                padding: 5mm;
                box-sizing: border-box;
            }
            
            .qr-grid { 
                display: grid !important; 
                grid-template-columns: repeat(3, 1fr) !important; 
                grid-template-rows: repeat(3, 1fr) !important;
                width: 205.9mm !important;
                height: 269.4mm !important;
                gap: 0 !important;
                margin: 0 auto !important;
            }

            .qr-print-card {
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 0.1mm solid #ddd;
                box-sizing: border-box;
                padding: 4mm;
                overflow: hidden;
            }

            .page-break { 
                page-break-after: always;
                break-after: page;
            }

            body { 
                background: white !important; 
                -webkit-print-color-adjust: exact; 
                margin: 0; 
                padding: 0; 
            }

            .master-list-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 8pt;
            }
            .master-list-table th, .master-list-table td {
                border: 0.5pt solid black;
                padding: 3px;
                text-align: left;
                text-transform: uppercase;
            }
            .master-list-table th {
                background-color: #f0f0f0 !important;
                font-weight: bold;
            }
        }

        .print-only { display: none; }
        .tab-active { border-bottom: 4px solid var(--primary-green); color: var(--primary-green); font-weight: bold; }
        .subtab-active { background-color: var(--primary-green) !important; color: white !important; }
        
        .cat-active { border-bottom: 3px solid var(--primary-green) !important; color: var(--primary-green) !important; font-weight: bold; background-color: #f0fdf4; }
        .cat-active-orange { border-bottom: 3px solid var(--accent-orange) !important; color: var(--accent-orange) !important; font-weight: bold; background-color: #fff7ed; }
        .inner-tab-active { background-color: var(--primary-green) !important; color: white !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        #qr-reader video { border-radius: 12px; }
        .qr-wrapper canvas, .qr-wrapper img { margin: 0 auto; max-width: 100%; height: auto; }
        
        .report-card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; overflow: hidden; }
        .attendance-table th { background-color: #f8fafc; color: #64748b; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.75rem 1rem; border-bottom: 2px solid #e2e8f0; }
        .attendance-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
        
        .qr-container-relative { position: relative; display: inline-block; }
        .qr-logo-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 25%; 
            box-shadow: 0 0 0 2px white;
        }
        .qr-logo-img { width: 100%; height: auto; display: block; }
        .qr-logo-id { font-size: 4.5pt; font-weight: 900; color: black; line-height: 1; margin-top: 1px; font-family: monospace; letter-spacing: -0.2px; }
        
        .selection-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            background: #fff;
        }

        #section-login {
            min-height: 100svh;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">

    <!-- MODAL MENSAJES -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 space-y-4 border-t-4 border-[#0e5b2f]">
            <h3 id="modal-msg-title" class="text-lg font-bold text-[#0e5b2f] uppercase tracking-tighter text-center">Aviso</h3>
            <p id="modal-msg-body" class="text-sm text-slate-600 font-medium text-center"></p>
            <div id="modal-msg-footer" class="flex gap-2 pt-2">
                <button id="btn-modal-confirm" class="flex-1 bg-[#e96925] text-white py-2 rounded-lg font-bold text-xs uppercase shadow-md active:scale-95 transition-transform">Aceptar</button>
                <button id="btn-modal-cancel" class="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg font-bold text-xs uppercase">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDICIÓN -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[150] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border-t-8 border-[#0e5b2f]">
            <div class="p-6 bg-slate-50 border-b flex justify-between items-center">
                <h3 class="text-lg font-black text-[#0e5b2f] uppercase">Editar Registro</h3>
                <button onclick="window.closeEditModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="edit-modal-body" class="p-6 space-y-4"></div>
            <div class="p-4 bg-slate-50 border-t flex gap-2">
                <button onclick="window.closeEditModal()" class="flex-1 py-2 rounded-xl font-bold text-xs uppercase text-slate-500 hover:bg-slate-100">Cancelar</button>
                <button id="btn-save-edit" class="flex-1 bg-[#e96925] text-white py-2 rounded-xl font-bold text-xs uppercase shadow-lg">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL SEGURIDAD -->
    <div id="forced-id-modal" class="fixed inset-0 bg-[#0e5b2f] z-[250] hidden flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full space-y-6 text-center border-t-8 border-[#e96925]">
            <i class="fas fa-user-shield text-5xl text-[#e96925]"></i>
            <div class="space-y-2">
                <h2 class="text-xl font-black text-[#0e5b2f] uppercase">Seguridad Requerida</h2>
                <p class="text-xs text-slate-500 font-bold uppercase leading-tight">Debe personalizar su ID para activar su cuenta.</p>
            </div>
            <div class="space-y-3">
                <input id="input-forced-new-id" type="text" placeholder="SU NUEVO ID" class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl outline-none focus:border-[#e96925] text-center text-lg font-black uppercase transition-all">
                <button onclick="window.updateTeacherForcedId()" class="w-full bg-[#e96925] text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform uppercase tracking-widest">Actualizar y Entrar</button>
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <section id="section-login" class="fixed inset-0 bg-[#0e5b2f] z-[100] overflow-y-auto p-4 flex flex-col">
        <div class="m-auto bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full space-y-6 text-center border-t-8 border-[#e96925] relative">
            <img src="logo.png" alt="Logo" class="h-20 mx-auto object-contain mb-2" onerror="this.style.display='none'">
            <h1 class="text-2xl font-bold text-[#0e5b2f] uppercase leading-tight">Colegio Xochicalli</h1>
            <div id="login-container" class="space-y-4 text-center">
                <p class="text-sm text-slate-500 uppercase font-bold tracking-tighter">Identificación de Personal</p>
                <input id="input-login-id" type="text" placeholder="ID PERSONAL" onfocus="this.scrollIntoView({behavior: 'smooth', block: 'center'});" class="w-full px-4 py-3 border-2 border-slate-100 rounded-xl outline-none focus:border-[#e96925] text-center text-lg font-bold uppercase transition-all">
                <button id="btn-login" onclick="window.attemptLogin()" disabled class="w-full bg-[#e96925] hover:bg-[#d1581d] text-white font-bold py-3 rounded-xl shadow-lg transition-all uppercase tracking-widest disabled:bg-slate-400">
                    <span id="login-btn-text">Conectando...</span>
                </button>
                <div id="login-error" class="text-xs font-bold text-red-500 hidden uppercase italic text-center">ID NO RECONOCIDO</div>
                <div id="admin-hint" class="hidden mt-6 p-3 bg-orange-50 border border-orange-100 rounded-xl text-center">
                    <p class="text-[10px] text-orange-700 font-bold uppercase italic">Ingrese ID: <span class="text-xs font-black">ADMIN</span></p>
                </div>
            </div>
        </div>
        <div class="h-32 flex-shrink-0 sm:hidden"></div>
    </section>

    <!-- HEADER -->
    <header id="main-header" class="bg-white shadow-sm no-print hidden border-b border-slate-100">
        <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="logo.png" alt="Logo Header" class="h-14 w-auto object-contain" onerror="this.style.display='none'">
                <div class="flex flex-col">
                    <h1 class="text-xl font-bold uppercase text-[#0e5b2f] leading-none">Colegio Xochicalli</h1>
                    <div class="flex flex-col mt-1">
                        <span id="user-display-name" class="text-xs font-black text-slate-700 uppercase leading-none">Usuario</span>
                        <span id="user-display-role" class="text-[9px] text-[#e96925] font-bold tracking-widest uppercase italic leading-tight">Cargando...</span>
                    </div>
                </div>
            </div>
            <nav class="flex gap-1 bg-slate-100 p-1 rounded-lg items-center">
                <button onclick="window.switchTab('scanner')" id="tab-scanner" class="px-4 py-2 rounded-md transition-all text-xs font-bold uppercase"><i class="fas fa-camera mr-1"></i>Pasar Lista</button>
                <button onclick="window.switchTab('admin')" id="tab-admin" class="px-4 py-2 rounded-md transition-all text-xs font-bold uppercase hidden"><i class="fas fa-users-cog mr-1"></i>Control Escolar</button>
                <div class="h-6 w-px bg-slate-300 mx-2"></div>
                <button onclick="window.logout()" class="p-2 text-red-500 hover:text-red-700 transition-colors"><i class="fas fa-power-off"></i></button>
            </nav>
        </div>
    </header>

    <main id="main-content" class="max-w-6xl mx-auto p-4 md:p-6 no-print hidden">
        <!-- SECCION ADMIN / CONTROL ESCOLAR -->
        <section id="section-admin" class="hidden space-y-6">
            <div class="flex flex-wrap gap-2 border-b border-slate-200 pb-4">
                <button onclick="window.switchSubTab('asistencia')" id="subtab-asistencia" class="px-4 py-2 rounded-lg bg-white border text-xs font-bold uppercase text-slate-600 transition-all">Asistencia</button>
                <button onclick="window.switchSubTab('mantenimiento')" id="subtab-mantenimiento" class="px-4 py-2 rounded-lg bg-white border text-xs font-bold uppercase text-[#e96925] transition-all">Mantenimiento</button>
                <button onclick="window.switchSubTab('historial')" id="subtab-historial" class="hidden px-4 py-2 rounded-lg bg-white border text-xs font-bold uppercase text-indigo-600 transition-all"><i class="fas fa-history mr-1"></i>Historial</button>
            </div>

            <!-- ASISTENCIA -->
            <div id="subcontent-asistencia" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-xl shadow-sm border flex flex-wrap gap-4 items-end shadow-sm">
                    <div class="flex-1 min-w-[140px]"><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Desde</label><input id="date-from" type="date" class="w-full px-3 py-2 border rounded-lg text-xs outline-none"></div>
                    <div class="flex-1 min-w-[140px]"><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Hasta</label><input id="date-to" type="date" class="w-full px-3 py-2 border rounded-lg text-xs outline-none"></div>
                    <div class="flex-1 min-w-[140px]"><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Grupo</label>
                        <select id="select-group" class="w-full px-3 py-2 border rounded-lg text-xs font-bold uppercase outline-none">
                            <option value="all">ENTRADA</option>
                            <optgroup label="PRIMARIA"><option value="1p">1P</option><option value="2p">2P</option><option value="3p">3P</option><option value="4p">4P</option><option value="5p">5P</option><option value="6p">6P</option></optgroup>
                            <optgroup label="SECUNDARIA"><option value="1s">1S</option><option value="2s">2S</option><option value="3s">3S</option></optgroup>
                        </select>
                    </div>
                    <button onclick="window.generateAttendanceReport()" class="bg-[#0e5b2f] text-white font-bold px-5 py-2.5 rounded-lg text-xs uppercase shadow-sm hover:opacity-90 transition-all">Consultar</button>
                </div>
                <div id="attendance-report-container" class="hidden space-y-4">
                    <div class="report-card p-6 shadow-md border bg-white">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="font-black text-[#0e5b2f] uppercase text-xl">Reporte de Asistencia</h2>
                            <button onclick="window.printAttendanceReport()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase hover:bg-black transition-colors"><i class="fas fa-print mr-1"></i>Imprimir Reporte</button>
                        </div>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="w-full text-left attendance-table border-collapse">
                                <thead id="report-table-head" class="bg-slate-50 text-[9px] uppercase font-bold border-b text-slate-500"></thead>
                                <tbody id="report-table-body" class="divide-y text-xs"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MANTENIMIENTO -->
            <div id="subcontent-mantenimiento" class="hidden space-y-6">
                <div class="flex gap-4 border-b border-slate-200 pb-2">
                    <button onclick="window.switchMaintCategory('registros')" id="maint-cat-registros" class="maint-cat-btn pb-2 px-4 text-xs font-bold uppercase border-b-2 border-transparent transition-all">Registros</button>
                    <button onclick="window.switchMaintCategory('impresion')" id="maint-cat-impresion" class="maint-cat-btn pb-2 px-4 text-xs font-bold uppercase border-b-2 border-transparent transition-all">Impresión</button>
                    <button onclick="window.switchMaintCategory('sistema')" id="maint-cat-sistema" class="maint-cat-btn pb-2 px-4 text-xs font-bold uppercase border-b-2 border-transparent transition-all">Sistema</button>
                </div>

                <div id="innercontent-registros" class="hidden space-y-6">
                    <div class="flex gap-2 bg-slate-100 p-1 rounded-xl w-fit mb-4">
                        <button onclick="window.switchInnerTab('alumnos')" id="innertab-alumnos" class="inner-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all">Alumnos</button>
                        <button onclick="window.switchInnerTab('maestros')" id="innertab-maestros" class="inner-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all">Maestros</button>
                    </div>
                    <div id="div-captura-alumnos" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl border space-y-4 shadow-sm">
                            <h3 class="font-bold text-[#0e5b2f] uppercase text-xs border-b pb-2 text-center">Captura de Alumno</h3>
                            <input id="input-id" type="text" placeholder="ID ALUMNO (1P01)" class="w-full px-4 py-2 border rounded-lg uppercase font-bold outline-none focus:ring-1 focus:ring-[#0e5b2f]">
                            <input id="input-name" type="text" placeholder="NOMBRE COMPLETO" class="w-full px-4 py-2 border rounded-lg uppercase outline-none focus:ring-1 focus:ring-[#0e5b2f]">
                            <button onclick="window.addStudent()" class="w-full bg-[#0e5b2f] text-white font-bold py-2 rounded-lg uppercase text-sm shadow-md active:scale-95 transition-transform">Guardar Alumno</button>
                        </div>
                        <div class="bg-white p-6 rounded-xl border space-y-3 text-center shadow-sm">
                            <h3 class="font-bold text-[#0e5b2f] uppercase text-xs border-b pb-2">Acciones CSV</h3>
                            <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                            <button onclick="document.getElementById('csv-file-input').click()" class="w-full bg-slate-50 text-slate-600 py-2.5 rounded-lg border font-bold uppercase text-[10px] shadow-sm"><i class="fas fa-file-import mr-1"></i>Importar CSV</button>
                            <button onclick="window.exportStudentsCSV()" class="w-full bg-emerald-50 text-emerald-700 py-2.5 rounded-lg border font-bold uppercase text-[10px] shadow-sm"><i class="fas fa-file-export mr-1"></i>Exportar CSV</button>
                        </div>
                    </div>
                    <div id="div-captura-maestros" class="hidden">
                        <div class="bg-white p-6 rounded-xl border max-w-lg mx-auto space-y-4 shadow-lg">
                            <h3 class="font-bold text-[#0e5b2f] uppercase text-xs border-b pb-2 text-center">Alta de Personal</h3>
                            <input id="input-maestro-id" type="text" placeholder="ID TEMPORAL" class="w-full px-4 py-2 border rounded-lg uppercase font-bold outline-none">
                            <input id="input-maestro-name" type="text" placeholder="NOMBRE" class="w-full px-4 py-2 border rounded-lg uppercase outline-none">
                            <input id="input-maestro-materia" type="text" placeholder="ÁREA / MATERIA" class="w-full px-4 py-2 border rounded-lg uppercase outline-none">
                            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer">
                                <input type="checkbox" id="input-maestro-admin" class="w-4 h-4">
                                <span class="text-[10px] font-black text-slate-600 uppercase">Es Administrador</span>
                            </label>
                            <button onclick="window.addTeacher()" class="w-full bg-[#0e5b2f] text-white font-black py-2 rounded-lg uppercase active:scale-95 transition-transform">Guardar Maestro</button>
                        </div>
                    </div>
                </div>

                <div id="innercontent-impresion" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border text-center space-y-4 shadow-sm">
                        <h3 class="font-black text-[#0e5b2f] uppercase text-[10px]">Impresión 3x3</h3>
                        <button onclick="window.printAllQRs()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg uppercase text-[10px] transition-colors hover:bg-black">Imprimir Todo</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl border text-center space-y-4 shadow-sm">
                        <h3 class="font-black text-[#0e5b2f] uppercase text-[10px]">Por Grupo</h3>
                        <select id="select-print-group" class="w-full px-3 py-2 border rounded-lg text-xs font-bold uppercase outline-none focus:ring-1 focus:ring-[#e96925]">
                            <optgroup label="PRIMARIA"><option value="1P">1P</option><option value="2P">2P</option><option value="3P">3P</option><option value="4P">4P</option><option value="5P">5P</option><option value="6P">6P</option></optgroup>
                            <optgroup label="SECUNDARIA"><option value="1S">1S</option><option value="2S">2S</option><option value="3S">3S</option></optgroup>
                        </select>
                        <button onclick="window.printGroupByQR()" class="w-full bg-[#0e5b2f] text-white font-bold py-3 rounded-lg uppercase text-[10px]">Imprimir Grupo</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl border flex flex-col md:col-span-2 shadow-sm">
                        <h3 class="font-black text-[#0e5b2f] uppercase text-xs border-b pb-2 mb-2 text-center">Selección Individual</h3>
                        <input type="text" id="search-print-student" placeholder="BUSCAR ALUMNO..." onkeyup="window.filterPrintSelection()" class="w-full px-3 py-2 border rounded-lg text-xs uppercase mb-3 outline-none focus:ring-1 focus:ring-[#e96925]">
                        <div id="print-selection-list" class="selection-list-container flex-1 divide-y"></div>
                        <button onclick="window.printSelectedQRs()" class="w-full mt-4 bg-[#e96925] text-white font-black py-3 rounded-lg uppercase text-xs shadow-md active:scale-95 transition-transform">Imprimir Seleccionados</button>
                    </div>
                </div>

                <div id="innercontent-sistema" class="hidden space-y-4">
                    <div class="flex gap-2 bg-slate-100 p-1 rounded-xl w-fit">
                        <button onclick="window.switchSystemSubTab('borrar')" id="sys-tab-borrar" class="sys-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase text-slate-500 transition-all">Borrar Asistencias</button>
                        <button onclick="window.switchSystemSubTab('recuperar')" id="sys-tab-recuperar" class="sys-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase transition-all hidden">Recuperar Acceso</button>
                        <button onclick="window.switchSystemSubTab('limpieza')" id="sys-tab-limpieza" class="sys-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase text-red-600 font-black transition-all">Borrado Total</button>
                    </div>
                    
                    <div id="sys-content-borrar" class="hidden bg-white p-6 rounded-xl border max-w-md space-y-4 shadow-sm">
                        <h3 class="font-bold text-red-600 text-xs uppercase border-b pb-2 text-center">Borrar Asistencias (Periodo)</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Desde</label><input id="delete-date-from" type="date" class="w-full px-3 py-2 border rounded-lg text-xs outline-none"></div>
                            <div><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Hasta</label><input id="delete-date-to" type="date" class="w-full px-3 py-2 border rounded-lg text-xs outline-none"></div>
                        </div>
                        <button onclick="window.confirmClearAttendance()" class="w-full bg-red-600 text-white font-black py-2 rounded-lg text-[10px] uppercase active:scale-95 transition-transform">Eliminar Asistencias</button>
                    </div>

                    <div id="sys-content-recuperar" class="hidden space-y-4">
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h3 class="font-black text-indigo-700 text-xs uppercase border-b pb-4 mb-4 text-center">Panel de Recuperación</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase border-b">
                                        <tr><th class="px-4 py-2 border-b">Nombre</th><th class="px-4 py-2 border-b">ID Actual</th><th class="px-4 py-2 border-b text-center">Acción</th></tr>
                                    </thead>
                                    <tbody id="recovery-table-body" class="divide-y text-xs text-slate-600 font-semibold"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="sys-content-limpieza" class="hidden bg-white p-6 rounded-xl border max-w-md text-center shadow-lg border-red-100 p-8">
                        <p class="text-xs font-black text-red-600 uppercase mb-4 italic leading-tight leading-relaxed">ATENCIÓN: Se eliminará toda la base de datos de Alumnos, Maestros y Reportes permanentemente.</p>
                        <button onclick="window.confirmResetSystem()" class="w-full bg-red-800 text-white font-black py-3 rounded-lg text-[10px] uppercase shadow-md active:scale-95 transition-transform">VACIAR SISTEMA COMPLETAMENTE</button>
                    </div>
                </div>
            </div>

            <!-- BITACORA -->
            <div id="subcontent-historial" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-xl border flex justify-between items-center shadow-sm">
                    <h3 class="font-black text-indigo-900 uppercase text-xs">Bitácora Global</h3>
                    <button onclick="window.confirmResetHistory()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase border border-red-200 active:scale-95 transition-all">Limpiar Historial</button>
                </div>
                <div class="bg-white rounded-xl border overflow-hidden shadow-md">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-400 text-[9px] font-black uppercase border-b">
                            <tr><th class="px-6 py-3">Fecha / Hora</th><th class="px-6 py-3">Usuario</th><th class="px-6 py-3">Evento</th></tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y text-xs text-slate-600"></tbody>
                    </table>
                </div>
            </div>

            <!-- TABLA GENERAL -->
            <div id="general-table-container" class="bg-white rounded-xl border overflow-hidden shadow-lg">
                <div class="px-6 py-4 bg-slate-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 id="table-title-text" class="font-black text-[#0e5b2f] uppercase text-xs tracking-widest font-mono">BASE DE DATOS</h3>
                    <!-- BUSCADOR DINÁMICO -->
                    <div id="div-record-search" class="relative w-full md:w-1/2">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="record-search-input" placeholder="BUSCAR POR NOMBRE O ID..." onkeyup="window.handleRecordSearch()" class="w-full pl-8 pr-4 py-1.5 border rounded-lg text-xs uppercase font-bold outline-none focus:ring-1 focus:ring-[#e96925] border-slate-200 shadow-sm">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead id="table-headers" class="bg-slate-50 text-slate-400 text-[9px] font-black uppercase border-b"></thead>
                        <tbody id="data-table-body" class="divide-y divide-slate-100 text-sm font-semibold"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SCANNER -->
        <section id="section-scanner" class="space-y-6">
            <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
                <div class="bg-[#0e5b2f] p-4 text-white text-center">
                    <h2 class="text-lg font-black uppercase tracking-wide">Pase de Lista</h2>
                    <p id="current-materia-label" class="text-[10px] opacity-80 uppercase font-black text-[#e96925]">CONTROL DE ENTRADA</p>
                </div>
                <div class="p-5 space-y-4">
                    <!-- CONTROLES DE HORARIO Y TOLERANCIA -->
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 shadow-inner mb-2 grid grid-cols-2 gap-3">
                        <div class="text-center">
                            <label class="text-[9px] font-black text-orange-700 uppercase block mb-1">Hora Entrada</label>
                            <input id="entry-threshold-time" type="time" value="09:00" class="w-full px-2 py-1.5 border border-orange-200 rounded-lg text-center font-black text-sm outline-none focus:border-[#e96925] shadow-sm" onchange="window.saveGlobalConfig('entryThresholdTime', this.value)">
                        </div>
                        <div class="text-center">
                            <label class="text-[9px] font-black text-orange-700 uppercase block mb-1">Tolerancia (min)</label>
                            <input id="entry-tolerance-minutes" type="number" value="0" min="0" class="w-full px-2 py-1.5 border border-orange-200 rounded-lg text-center font-black text-sm outline-none focus:border-[#e96925] shadow-sm" onchange="window.saveGlobalConfig('entryToleranceMinutes', this.value)">
                        </div>
                    </div>

                    <div id="qr-reader-container" class="relative">
                        <div id="qr-reader" class="rounded-lg overflow-hidden border-2 border-dashed border-slate-200 bg-slate-50 min-h-[250px]"></div>
                        <div id="camera-off-overlay" class="hidden absolute inset-0 bg-slate-800/90 flex flex-col items-center justify-center text-white rounded-lg">
                            <i class="fas fa-video-slash text-4xl mb-2"></i>
                            <p class="text-sm font-black uppercase">Cámara Apagada</p>
                        </div>
                    </div>
                    <button onclick="window.toggleCamera()" class="w-full bg-slate-800 text-white font-black py-3 rounded-xl shadow-md uppercase text-xs active:scale-95 transition-transform hover:bg-black">
                        <i class="fas fa-power-off mr-2"></i> <span id="btn-camera-text">Apagar Cámara</span>
                    </button>
                    
                    <div class="bg-slate-100 p-4 rounded-xl border shadow-inner text-center">
                        <h4 class="text-[9px] font-black text-slate-400 uppercase mb-2">Registro Manual (ID Alumno)</h4>
                        <div class="flex gap-2">
                            <input id="input-manual-id" type="text" placeholder="ID ALUMNO" class="flex-1 px-4 py-2 border rounded-lg uppercase text-sm font-black outline-none focus:ring-2 focus:ring-[#e96925] shadow-sm">
                            <button onclick="window.manualAttendance()" class="bg-[#e96925] text-white px-5 py-2 rounded-lg text-xs font-black uppercase shadow-md active:scale-95 transition-transform">OK</button>
                        </div>
                    </div>

                    <div id="scan-status" class="p-4 rounded-lg text-center font-black hidden uppercase text-xs shadow-md"></div>
                </div>
            </div>
            <div class="bg-white rounded-xl border overflow-hidden max-w-2xl mx-auto shadow-md">
                <div class="px-4 py-3 bg-slate-50 border-b flex justify-between items-center">
                    <h3 class="font-black text-[10px] uppercase text-[#0e5b2f]">Movimientos de Hoy</h3>
                    <span id="scan-count" class="bg-orange-50 text-[#e96925] text-[10px] font-black px-3 py-1 rounded-full uppercase italic">0 HOY</span>
                </div>
                <ul id="recent-logs" class="divide-y max-h-60 overflow-y-auto"></ul>
            </div>
        </section>
    </main>

    <div id="print-area" class="print-only"><div id="print-content"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, deleteDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCXkAb_YnMSOcww5D6RQPMd56BSdCwkiB8",
            authDomain: "listadeasitencia.firebaseapp.com",
            projectId: "listadeasitencia",
            storageBucket: "listadeasitencia.firebasestorage.app",
            messagingSenderId: "379159619523",
            appId: "1:379159619523:web:7aeb44a8bdc6d24bdd3f76"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'listadeasitencia';

        let currentUser = null, loggedTeacher = null;
        let students = [], teachers = [], scannedTodayIds = new Set();
        let html5QrScanner = null, isScannerRunning = false, isScannerTransitioning = false;
        let audioCtx = null;
        let currentMaintCat = 'registros', currentInnerTab = 'alumnos', currentSysTab = 'borrar';

        const alumnosColl = collection(db, 'artifacts', appId, 'public', 'data', 'alumnos');
        const maestrosColl = collection(db, 'artifacts', appId, 'public', 'data', 'maestros');
        const asistenciasColl = collection(db, 'artifacts', appId, 'public', 'data', 'asistencias');
        const historialColl = collection(db, 'artifacts', appId, 'public', 'data', 'historial');
        const configColl = collection(db, 'artifacts', appId, 'public', 'data', 'config');

        /* --- FUNCIONES AUXILIARES GLOBALES (HOISTED) --- */
        const getMexicoDate = () => new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Mexico_City' }).format(new Date());
        const getMexicoTime = () => new Intl.DateTimeFormat('es-MX', { timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).format(new Date());
        window.getMexicoDate = getMexicoDate;
        window.getMexicoTime = getMexicoTime;

        function showModalMsg(title, message, callback = null, isConfirm = false) {
            const modal = document.getElementById('custom-modal'); if(!modal) return;
            document.getElementById('modal-msg-title').innerText = title; document.getElementById('modal-msg-body').innerText = message;
            const btnCancel = document.getElementById('btn-modal-cancel'), btnConfirm = document.getElementById('btn-modal-confirm');
            btnCancel.classList.toggle('hidden', !isConfirm); modal.classList.remove('hidden');
            const btnConfirmClone = btnConfirm.cloneNode(true); btnConfirm.replaceWith(btnConfirmClone);
            const btnCancelClone = btnCancel.cloneNode(true); btnCancel.replaceWith(btnCancelClone);
            const cleanup = () => modal.classList.add('hidden');
            btnConfirmClone.addEventListener('click', () => { cleanup(); if (callback) callback(); });
            if(isConfirm) btnCancelClone.addEventListener('click', cleanup);
        }
        window.showModalMsg = showModalMsg;

        function updateScannerUI(r) { 
            const b = document.getElementById('btn-camera-text'); 
            const o = document.getElementById('camera-off-overlay'); 
            if (r) { if(b) b.innerText = "Apagar Cámara"; if(o) o.classList.add('hidden'); } 
            else { if(b) b.innerText = "Encender Cámara"; if(o) o.classList.remove('hidden'); } 
        }
        window.updateScannerUI = updateScannerUI;

        async function initScanner() { 
            if (isScannerRunning || isScannerTransitioning) return; 
            isScannerTransitioning = true; 
            if (!html5QrScanner) html5QrScanner = new Html5Qrcode("qr-reader"); 
            try { 
                await html5QrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess); 
                isScannerRunning = true; window.updateScannerUI(true); 
            } catch (err) {} finally { isScannerTransitioning = false; } 
        }
        window.initScanner = initScanner;

        async function stopScanner() { 
            if (!isScannerRunning || isScannerTransitioning) return; 
            isScannerTransitioning = true; 
            try { 
                await html5QrScanner.stop(); 
                isScannerRunning = false; window.updateScannerUI(false); 
            } catch (err) {} finally { isScannerTransitioning = false; } 
        }
        window.stopScanner = stopScanner;

        function renderRecoveryTable() {
            const body = document.getElementById('recovery-table-body'); if(!body) return;
            const list = teachers.filter(t => t.id !== 'TLAHUISCALPANTECUTLI');
            if (list.length === 0) { body.innerHTML = `<tr><td colspan='3' class='p-8 text-center italic'>Sin registros</td></tr>`; return; }
            body.innerHTML = list.map(t => `<tr><td class='px-4 py-3 font-bold uppercase'>${t.nombre}</td><td class='px-4 py-3 font-mono text-[#0e5b2f] font-bold'>${t.id}</td><td class='px-4 py-3 text-center'><button onclick='window.confirmResetTeacherAccount("${t.id}")' class='bg-red-50 text-red-600 px-3 py-1 rounded-lg text-[10px] uppercase border border-red-200 hover:bg-red-100 transition-colors'>Reiniciar</button></td></tr>`).join('');
        }
        window.renderRecoveryTable = renderRecoveryTable;

        function renderStudentPrintList() {
            const list = document.getElementById('print-selection-list'); if(!list) return;
            list.innerHTML = students.length === 0 ? `<div class='p-4 text-center text-xs italic text-slate-400'>Sin registros</div>` : students.map(s => `<label class='flex items-center gap-3 p-2 hover:bg-slate-50 cursor-pointer'><input type='checkbox' class='print-student-check w-4 h-4 rounded text-[#e96925]' value='${s.id}'><div class='flex flex-col'><span class='text-xs font-bold uppercase'>${s.nombre}</span><span class='text-[9px] font-mono'>${s.id}</span></div></label>`).join('');
        }
        window.renderStudentPrintList = renderStudentPrintList;

        async function logAction(description) {
            if (!loggedTeacher) return;
            try { await addDoc(historialColl, { usuario: loggedTeacher.nombre, usuarioId: loggedTeacher.id, fecha: getMexicoDate(), hora: getMexicoTime(), descripcion: description, timestamp: serverTimestamp() }); } catch (e) {}
        }
        window.logAction = logAction;

        function showStatus(m, y) {
            const e = document.getElementById('scan-status'); if (!e) return;
            e.innerText = m; e.className = `p-4 rounded-lg text-center font-bold block ${y === 'success' ? 'bg-green-100 text-green-700' : (y === 'warning' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700')}`;
            e.classList.remove('hidden');
        }
        window.showStatus = showStatus;

        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playSuccessSound() { 
            initAudio(); const playTone = (t) => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(880, t); 
                g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.7, t + 0.05); g.gain.linearRampToValueAtTime(0, t + 0.15); 
                o.start(t); o.stop(t + 0.15);
            };
            playTone(audioCtx.currentTime); playTone(audioCtx.currentTime + 0.2);
        }
        function playLateSound() {
            initAudio(); const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(440, audioCtx.currentTime); 
            g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.1); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.8); 
            o.start(); o.stop(audioCtx.currentTime + 0.8);
        }
        function playErrorSound() { 
            initAudio(); const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(120, audioCtx.currentTime); 
            g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.7, audioCtx.currentTime + 0.1); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4); 
            o.start(); o.stop(audioCtx.currentTime + 0.4); 
        }

        /* --- MOTOR ASISTENCIA CON TOLERANCIA --- */
        async function onScanSuccess(t) { await window.processAttendance(t); }

        window.processAttendance = async (t) => {
            if (!currentUser || !loggedTeacher) return;
            if (isScannerRunning) try { await html5QrScanner.pause(); } catch(e) {}
            const id = t.trim().toUpperCase();
            const now = getMexicoTime();
            
            // LÓGICA DE TIEMPO
            const entryVal = document.getElementById('entry-threshold-time').value;
            const toleranceMin = parseInt(document.getElementById('entry-tolerance-minutes').value) || 0;
            const [eH, eM] = entryVal.split(':').map(Number);
            
            const limitSec = (eH * 3600) + (eM * 60);
            const toleranceLimitSec = limitSec + (toleranceMin * 60);
            
            const [nH, nM, nS] = now.split(':').map(Number);
            const nowSeconds = (nH * 3600) + (nM * 60) + nS;

            let calculatedStatus = "A TIEMPO";
            if (nowSeconds > toleranceLimitSec) calculatedStatus = "RETARDO";
            else if (nowSeconds > limitSec) calculatedStatus = "TOLERANCIA";

            if (scannedTodayIds.has(id)) { initAudio(); playErrorSound(); window.showStatus(`YA REGISTRADO HOY: ${id}`, "warning"); }
            else {
                try {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', id));
                    if (snap.exists()) {
                        await addDoc(asistenciasColl, { 
                            alumnoId: id, 
                            nombre: snap.data().nombre, 
                            profesorId: loggedTeacher.id, 
                            profesorNombre: loggedTeacher.nombre, 
                            fecha: getMexicoDate(), 
                            hora: now, 
                            thresholdTime: entryVal,
                            toleranceMinutes: toleranceMin,
                            status: calculatedStatus,
                            timestamp: serverTimestamp() 
                        });
                        
                        initAudio(); 
                        if (calculatedStatus === "RETARDO") { 
                            playLateSound(); window.showStatus(`RETARDO: ${snap.data().nombre}`, "warning"); 
                        } else if (calculatedStatus === "TOLERANCIA") {
                            playLateSound(); window.showStatus(`TOLERANCIA: ${snap.data().nombre}`, "warning");
                        } else { 
                            playSuccessSound(); window.showStatus(`REGISTRADO: ${snap.data().nombre}`, "success"); 
                        }
                    } else { initAudio(); playErrorSound(); window.showStatus("ID NO ENCONTRADO", "error"); }
                } catch (e) {}
            }
            setTimeout(async () => { if (isScannerRunning) try { await html5QrScanner.resume(); } catch(e) {} const st = document.getElementById('scan-status'); if(st) st.classList.add('hidden'); }, 2000);
        };

        window.manualAttendance = () => {
            const input = document.getElementById('input-manual-id');
            const val = input.value.trim(); if(!val) return;
            window.processAttendance(val); input.value = '';
        };

        function listenToAttendanceToday() { 
            if (!currentUser || !loggedTeacher) return; 
            onSnapshot(asistenciasColl, (snap) => { 
                const today = getMexicoDate(); scannedTodayIds.clear(); 
                const allLogs = snap.docs.map(d => d.data()).filter(d => d.fecha === today);
                allLogs.filter(l => l.profesorId === loggedTeacher.id).forEach(l => scannedTodayIds.add(l.alumnoId)); 
                document.getElementById('scan-count').innerText = `${allLogs.length} HOY`; 
                
                document.getElementById('recent-logs').innerHTML = allLogs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 10).map(l => {
                    const isLate = l.status === "RETARDO";
                    const isTol = l.status === "TOLERANCIA";
                    const borderClass = isLate ? 'border-amber-400' : (isTol ? 'border-orange-200' : 'border-emerald-500');
                    return `<li class="p-4 flex justify-between bg-white border-l-4 ${borderClass}"><div><p class="font-bold uppercase text-xs">${l.nombre}</p><p class="text-[9px] text-slate-400">ID: ${l.alumnoId}</p></div><div class="flex flex-col items-end"><span class="text-[10px] font-mono font-black">${l.hora || '--:--'}</span><span class="text-[8px] font-black italic uppercase">${l.status === 'A TIEMPO' ? '' : l.status}</span></div></li>`;
                }).join(''); 
            }); 
        }

        async function initializeApplication() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (e) { await signInAnonymously(auth); }

            onAuthStateChanged(auth, async (u) => { 
                currentUser = u; if (u) { 
                    document.getElementById('btn-login').disabled = false; 
                    document.getElementById('login-btn-text').innerText = 'Entrar';
                    const sSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'));
                    if (sSnap.exists()) {
                        if(sSnap.data().entryThresholdTime) document.getElementById('entry-threshold-time').value = sSnap.data().entryThresholdTime;
                        if(sSnap.data().entryToleranceMinutes) document.getElementById('entry-tolerance-minutes').value = sSnap.data().entryToleranceMinutes;
                    }
                    try {
                        const snap = await getDocs(maestrosColl); const hint = document.getElementById('admin-hint');
                        if (snap.empty && hint) hint.classList.remove('hidden'); else if (hint) hint.classList.add('hidden');
                    } catch (e) {}
                } 
            });

            const today = getMexicoDate();
            if(document.getElementById('date-from')) document.getElementById('date-from').value = today;
            if(document.getElementById('date-to')) document.getElementById('date-to').value = today;
            const csvInput = document.getElementById('csv-file-input');
            if(csvInput) csvInput.addEventListener('change', window.handleCSVUpload);
        }

        /* --- VINCULOS WINDOW --- */
        window.attemptLogin = async () => {
            const inputVal = document.getElementById('input-login-id').value.trim(); if (!inputVal) return;
            const id = inputVal.toUpperCase(); const btn = document.getElementById('btn-login'), btnTxt = document.getElementById('login-btn-text');
            btn.disabled = true; btnTxt.innerText = "Verificando...";
            try {
                if (id === 'TLAHUISCALPANTECUTLI') { loggedTeacher = { id: 'TLAHUISCALPANTECUTLI', nombre: 'SUPERUSUARIO', esAdmin: true }; enterApp(); return; }
                if (id === 'ENTRADA') { loggedTeacher = { id: 'ENTRADA', nombre: 'CONTROL ENTRADA', esAdmin: false }; enterApp(); return; }
                const snapM = await getDocs(maestrosColl);
                const hAdmin = snapM.docs.some(d => d.data().esAdmin === true && d.id !== 'TLAHUISCALPANTECUTLI');
                if (!hAdmin && id === 'ADMIN') { loggedTeacher = { id: 'ADMIN', nombre: 'ADMIN INICIAL', esAdmin: true }; enterApp(); return; }
                const tDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', id));
                if (tDoc.exists()) { loggedTeacher = { id: tDoc.id, ...tDoc.data() }; enterApp(); }
                else { document.getElementById('login-error').classList.remove('hidden'); initAudio(); playErrorSound(); setTimeout(() => document.getElementById('login-error').classList.add('hidden'), 3000); }
            } catch (e) {} finally { btn.disabled = false; btnTxt.innerText = "Entrar"; }
        };

        function enterApp() {
            document.getElementById('section-login').style.display = 'none';
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            const nEl = document.getElementById('user-display-name'), rEl = document.getElementById('user-display-role');
            if(nEl) nEl.innerText = loggedTeacher.nombre;
            const isSuper = loggedTeacher.id === 'TLAHUISCALPANTECUTLI', isAdmin = loggedTeacher.esAdmin, isEntrance = loggedTeacher.id === 'ENTRADA';
            if(rEl) rEl.innerText = isSuper ? 'SUPERUSUARIO' : (isEntrance ? 'PORTERÍA' : (isAdmin ? 'ADMINISTRADOR' : 'DOCENTE'));
            if(loggedTeacher.id !== 'ADMIN' && !isSuper && !isEntrance && !loggedTeacher.idCambiado) document.getElementById('forced-id-modal').classList.remove('hidden');
            
            const showAdminTab = !isEntrance;
            document.getElementById('tab-admin').classList.toggle('hidden', !showAdminTab);
            const btnMaint = document.getElementById('subtab-mantenimiento'), btnHist = document.getElementById('subtab-historial');
            if (isSuper || isAdmin) btnMaint.classList.remove('hidden'); else btnMaint.classList.add('hidden');
            
            const tabRecuperar = document.getElementById('sys-tab-recuperar');
            if (isSuper) {
                btnHist.classList.remove('hidden');
                if(tabRecuperar) tabRecuperar.classList.remove('hidden');
            } else {
                btnHist.classList.add('hidden');
                if(tabRecuperar) tabRecuperar.classList.add('hidden');
            }
            loadStudents(); loadTeachers(); listenToAttendanceToday(); window.switchTab('scanner');
        }

        window.switchTab = async (t) => {
            document.getElementById('section-scanner').classList.toggle('hidden', t !== 'scanner');
            document.getElementById('section-admin').classList.toggle('hidden', t !== 'admin');
            if (t === 'scanner') await window.initScanner(); else { await stopScanner(); window.switchSubTab('asistencia'); }
        };

        window.switchSubTab = (s) => {
            ['asistencia', 'mantenimiento', 'historial'].forEach(x => {
                const sub = document.getElementById('subcontent-' + x); if(sub) sub.classList.add('hidden');
                const btn = document.getElementById('subtab-' + x); if(btn) btn.classList.remove('subtab-active');
            });
            const sel = document.getElementById('subcontent-' + s); if(sel) sel.classList.remove('hidden');
            const b = document.getElementById('subtab-' + s); if(b) b.classList.add('subtab-active');
            
            document.getElementById('record-search-input').value = '';
            document.getElementById('general-table-container').classList.add('hidden');
            document.getElementById('attendance-report-container').classList.add('hidden');
            
            if (s === 'mantenimiento') window.switchMaintCategory('registros');
            else if (s === 'historial') listenToHistorial();
        };

        window.switchMaintCategory = (c) => {
            currentMaintCat = c;
            document.querySelectorAll('.maint-cat-btn').forEach(b => b.className = "maint-cat-btn pb-2 px-4 text-xs font-bold uppercase border-b-2 border-transparent transition-all");
            const act = document.getElementById('maint-cat-' + c); if(act) act.classList.add(c === 'sistema' ? 'cat-active-orange' : 'cat-active');
            ['registros', 'impresion', 'sistema'].forEach(x => { const inn = document.getElementById('innercontent-' + x); if(inn) inn.classList.add('hidden'); });
            document.getElementById('general-table-container').classList.add('hidden');
            const target = document.getElementById('innercontent-' + c); if(target) target.classList.remove('hidden');
            
            const isSuper = loggedTeacher && loggedTeacher.id === 'TLAHUISCALPANTECUTLI';
            const tabRecuperar = document.getElementById('sys-tab-recuperar');
            if(tabRecuperar) { if(isSuper) tabRecuperar.classList.remove('hidden'); else tabRecuperar.classList.add('hidden'); }

            if (c === 'registros') window.switchInnerTab(currentInnerTab);
            else if (c === 'impresion') window.renderStudentPrintList();
            else if (c === 'sistema') window.switchSystemSubTab(currentSysTab);
        };

        window.switchInnerTab = (t) => {
            currentInnerTab = t;
            document.getElementById('record-search-input').value = ''; 
            document.querySelectorAll('.inner-tab-btn').forEach(b => b.className = "inner-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase text-slate-500 transition-all");
            const btn = document.getElementById('innertab-' + t); if(btn) btn.className = "inner-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase inner-tab-active text-white shadow-sm transition-all";
            document.getElementById('div-captura-alumnos').classList.toggle('hidden', t !== 'alumnos');
            document.getElementById('div-captura-maestros').classList.toggle('hidden', t !== 'maestros');
            renderTable(t === 'alumnos' ? "catalog" : "teachers");
        };

        window.switchSystemSubTab = (t) => {
            currentSysTab = t;
            const isSuper = loggedTeacher && loggedTeacher.id === 'TLAHUISCALPANTECUTLI';
            document.querySelectorAll('.sys-tab-btn').forEach(b => {
                b.className = "sys-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase text-slate-500 transition-all";
                if(b.id === 'sys-tab-recuperar' && !isSuper) b.classList.add('hidden');
            });
            if (!isSuper && t === 'recuperar') t = 'borrar';
            const act = document.getElementById('sys-tab-' + t); if(act) act.className = "sys-tab-btn px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase inner-tab-active text-white shadow-sm transition-all";
            ['borrar', 'recuperar', 'limpieza'].forEach(x => { const sc = document.getElementById('sys-content-' + x); if(sc) sc.classList.add('hidden'); });
            const sel = document.getElementById('sys-content-' + t); if(sel) sel.classList.remove('hidden');
            if (t === 'recuperar') window.renderRecoveryTable();
        };

        window.handleRecordSearch = () => {
            const queryVal = document.getElementById('record-search-input').value.toUpperCase();
            renderTable(currentInnerTab === 'alumnos' ? "catalog" : "teachers", queryVal);
        };

        window.addStudent = async () => {
            const id = document.getElementById('input-id').value.trim().toUpperCase(), nombre = document.getElementById('input-name').value.trim().toUpperCase();
            if (!id || !nombre) return;
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', id), { nombre, createdAt: serverTimestamp() }); document.getElementById('input-id').value = ''; document.getElementById('input-name').value = ''; await loadStudents(); window.showStatus("Guardado", "success"); } catch(e) {}
        };
        window.addTeacher = async () => {
            const iE = document.getElementById('input-maestro-id'), nE = document.getElementById('input-maestro-name'), mE = document.getElementById('input-maestro-materia'), aE = document.getElementById('input-maestro-admin');
            const id = iE.value.trim().toUpperCase(), nombre = nE.value.trim().toUpperCase(), materia = mE.value.trim().toUpperCase(), esAdmin = aE.checked;
            if (!id || !nombre) return;
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', id), { nombre, materia, esAdmin, idCambiado: false }); iE.value = ''; nE.value = ''; mE.value = ''; aE.checked = false; await loadTeachers(); window.showStatus("Guardado", "success"); } catch(e) {}
        };
        window.confirmClearAttendance = () => {
            const f = document.getElementById('delete-date-from').value, t = document.getElementById('delete-date-to').value;
            if (!f || !t) return window.showModalMsg("Aviso", "Seleccione fechas.");
            window.showModalMsg("⚠️ BORRAR", "¿Eliminar asistencias del periodo?", async () => {
                const snap = await getDocs(asistenciasColl);
                let count = 0;
                for (const d of snap.docs) if (d.data().fecha >= f && d.data().fecha <= t) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'asistencias', d.id)); count++; }
                window.showModalMsg("Éxito", `${count} eliminados.`);
            }, true);
        };
        window.confirmResetSystem = () => {
            window.showModalMsg("VACIAR TODO", "¿Borrar absolutamente todo?", async () => {
                const as = await getDocs(asistenciasColl); for (const d of as.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'asistencias', d.id));
                const al = await getDocs(alumnosColl); for (const d of al.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', d.id));
                const ma = await getDocs(maestrosColl); for (const d of ma.docs) if(d.id !== 'TLAHUISCALPANTECUTLI') await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', d.id));
                location.reload();
            }, true);
        };
        window.generateAttendanceReport = async () => {
            const from = document.getElementById('date-from').value, to = document.getElementById('date-to').value, group = document.getElementById('select-group').value;
            if (!from || !to) return;
            try {
                const snap = await getDocs(asistenciasColl); 
                const logs = snap.docs.map(d => d.data()).filter(l => l.fecha >= from && l.fecha <= to);
                const attMap = {}; logs.forEach(l => { if(!attMap[l.alumnoId]) attMap[l.alumnoId] = []; attMap[l.alumnoId].push(l); });
                let filtered = students.filter(s => group === "all" || s.id.substring(0, 2).toLowerCase() === group);
                const isGeneral = group === 'all';
                let headHtml = `<tr><th class='text-center'>#</th><th>Nombre</th>${isGeneral ? '<th>Fecha</th><th>Hora</th><th>Estatus</th>' : '<th>Asistencias</th>' }</tr>`;
                let bodyHtml = "";
                if(isGeneral) {
                    let idx = 1;
                    filtered.forEach(s => {
                        const sLogs = (attMap[s.id] || []).sort((a,b) => a.fecha.localeCompare(b.fecha) || a.hora.localeCompare(b.hora));
                        sLogs.forEach(l => {
                            bodyHtml += `<tr><td class='text-center'>${idx++}</td><td>${s.nombre}</td><td>${l.fecha}</td><td>${l.hora}</td><td>${l.status === 'A TIEMPO' ? '' : l.status}</td></tr>`;
                        });
                    });
                } else {
                    const uniqueDates = Array.from(new Set(logs.map(l => l.fecha))).sort();
                    headHtml = `<tr><th>#</th><th>Alumno</th>${uniqueDates.map(d => `<th class='text-center'>${d.substring(5)}</th>`).join('')}<th>Total</th></tr>`;
                    bodyHtml = filtered.map((s, idx) => {
                        let tot = 0;
                        const cells = uniqueDates.map(d => {
                            const found = (attMap[s.id] || []).find(l => l.fecha === d);
                            if(found) tot++; else return `<td class='text-center text-red-400'>X</td>`;
                            return `<td class='text-center ${found.status === "A TIEMPO" ? "text-green-600" : "font-black"}'>${found.status === 'RETARDO' ? 'R' : (found.status === 'TOLERANCIA' ? 'T' : '✓')}</td>`;
                        }).join('');
                        return `<tr><td>${idx+1}</td><td class='font-bold'>${s.nombre}</td>${cells}<td class='font-black'>${tot}</td></tr>`;
                    }).join('');
                }
                document.getElementById('report-table-head').innerHTML = headHtml; document.getElementById('report-table-body').innerHTML = bodyHtml;
                document.getElementById('attendance-report-container').classList.remove('hidden'); document.getElementById('general-table-container').classList.add('hidden');
            } catch(e) {}
        };
        async function loadStudents() { if (!currentUser) return; const snap = await getDocs(alumnosColl); students = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.nombre.localeCompare(b.nombre)); if (currentInnerTab === 'alumnos') renderTable("catalog"); }
        async function loadTeachers() { if (!currentUser) return; const snap = await getDocs(maestrosColl); teachers = snap.docs.map(d => ({ id: d.id, ...d.data() })); if (currentInnerTab === 'maestros') renderTable("teachers"); if (currentSysTab === 'recuperar') window.renderRecoveryTable(); }
        
        function renderTable(mode, filterTerm = "") {
            const body = document.getElementById('data-table-body'), head = document.getElementById('table-headers');
            if(!body || !head) return; document.getElementById('attendance-report-container').classList.add('hidden'); document.getElementById('general-table-container').classList.remove('hidden');
            
            if (mode === "catalog") {
                head.innerHTML = `<tr><th class='px-6 py-3 border-b'>ID</th><th class='px-6 py-3 border-b'>Nombre</th><th class='px-6 py-3 border-b text-center'>E</th><th class='px-6 py-3 border-b text-center'>X</th></tr>`;
                const data = filterTerm ? students.filter(s => s.nombre.includes(filterTerm) || s.id.includes(filterTerm)) : students;
                body.innerHTML = data.map(s => `<tr><td class='px-6 py-4 font-black'>${s.id}</td><td class='px-6 py-4'>${s.nombre}</td><td class='px-6 py-4 text-center'><button onclick='window.editStudent("${s.id}")'><i class='fas fa-edit'></i></button></td><td class='px-6 py-4 text-center'><button onclick='window.confirmDeleteStudent("${s.id}", "${s.nombre}")'><i class='fas fa-trash-alt'></i></button></td></tr>`).join('');
            } else if (mode === "teachers") {
                head.innerHTML = `<tr><th class='px-6 py-3 border-b'>ID</th><th class='px-6 py-3 border-b'>Nombre</th><th class='px-6 py-3 border-b text-center'>E</th><th class='px-6 py-3 border-b text-center'>X</th></tr>`;
                const rawData = teachers.filter(t => t.id !== 'TLAHUISCALPANTECUTLI');
                const data = filterTerm ? rawData.filter(t => t.nombre.includes(filterTerm) || (t.id.includes(filterTerm) && !t.idCambiado)) : rawData;
                body.innerHTML = data.map(t => `<tr><td class='px-6 py-4 font-black'>${t.idCambiado ? '<i class="fas fa-lock text-slate-300"></i>' : t.id}</td><td class='px-6 py-4'>${t.nombre}</td><td class='px-6 py-4 text-center'><button onclick='window.editTeacher("${t.id}")'><i class='fas fa-edit'></i></button></td><td class='px-6 py-4 text-center'><button onclick='window.confirmDeleteTeacher("${t.id}", "${t.nombre}")'><i class='fas fa-trash-alt'></i></button></td></tr>`).join('');
            }
        }
        function listenToHistorial() {
            if (!currentUser || (loggedTeacher && loggedTeacher.id !== 'TLAHUISCALPANTECUTLI')) return;
            onSnapshot(historialColl, (snap) => {
                const body = document.getElementById('history-table-body'); if(!body) return;
                const logs = snap.docs.map(d => d.data()).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                body.innerHTML = logs.map(l => `<tr><td class='px-6 py-3 font-mono'>${l.fecha} ${l.hora}</td><td class='px-6 py-3 font-bold uppercase'>${l.usuario}</td><td class='px-6 py-3'>${l.descripcion}</td></tr>`).join('');
            });
        }

        window.saveGlobalConfig = async (key, value) => { if (!currentUser) return; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), { [key]: value }, { merge: true }); } catch(e) {} };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.printAttendanceReport = () => window.print();
        window.exportStudentsCSV = () => { const csv = Papa.unparse(students.map(s => ({ ID: s.id, Nombre: s.nombre }))); const link = document.createElement("a"); link.setAttribute("href", URL.createObjectURL(new Blob([csv], { type: 'text/csv' }))); link.setAttribute("download", `Alumnos_Colegio.csv`); link.click(); };
        window.printAllQRs = async () => { if (students.length === 0) return; await performQRPrint(students, "Total"); };
        window.printGroupByQR = async () => { const g = document.getElementById('select-print-group').value.toUpperCase(); const f = students.filter(s => s.id.substring(0, 2).toUpperCase() === g); if(f.length === 0) return window.showModalMsg("Aviso", "No hay alumnos."); await performQRPrint(f, `Grupo ${g}`); };
        window.printSelectedQRs = async () => { const checks = document.querySelectorAll('.print-student-check:checked'); if(checks.length === 0) return window.showModalMsg("Aviso", "Seleccione alumnos."); const ids = Array.from(checks).map(c => c.value); await performQRPrint(students.filter(s => ids.includes(s.id)), "Selección"); checks.forEach(c => c.checked = false); };
        window.filterPrintSelection = () => { const q = document.getElementById('search-print-student').value.toUpperCase(); document.querySelectorAll('.print-item-row').forEach(r => r.style.display = r.innerText.toUpperCase().includes(q) ? 'flex' : 'none'); };
        window.updateTeacherForcedId = async () => { const newId = document.getElementById('input-forced-new-id').value.trim().toUpperCase(); if(!newId || newId === loggedTeacher.id) return window.showModalMsg("Aviso", "Ingrese un ID nuevo."); try { const checkDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', newId)); if(checkDoc.exists()) return window.showModalMsg("Aviso", "Este ID ya está en uso."); const oldId = loggedTeacher.id; const newData = { ...loggedTeacher, idCambiado: true }; delete newData.id; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', newId), newData); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', oldId)); loggedTeacher.id = newId; loggedTeacher.idCambiado = true; document.getElementById('forced-id-modal').classList.add('hidden'); } catch(e) {} };
        window.confirmResetTeacherAccount = (id) => { window.showModalMsg("Reiniciar Seguridad", "¿Invalidar el ID actual?", () => { const tempId = "TEMP_" + Math.floor(Math.random()*10000); window.showModalMsg("ID Temporal", `Nuevo ID: ${tempId}`, async () => { const tData = teachers.find(t => t.id === id); const newData = { ...tData, idCambiado: false }; delete newData.id; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', tempId), newData); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', id)); await loadTeachers(); }); }, true); };
        window.confirmResetHistory = () => { window.showModalMsg("Reiniciar", "¿Vaciar bitácora?", async () => { const snap = await getDocs(historialColl); for (const d of snap.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'historial', d.id)); await window.logAction("Bitácora reiniciada"); }, true); };
        window.logout = () => { location.reload(); };
        
        async function performQRPrint(list, logTag) { window.showModalMsg("Generando", `Preparando códigos...`); const area = document.getElementById('print-content'); document.getElementById('print-area').style.display = 'block'; let html = ""; for(let i = 0; i < list.length; i += 9) { const chunk = list.slice(i, i + 9); html += `<div class='qr-grid ${i + 9 < list.length ? 'page-break' : ''}'>`; for (const s of chunk) html += `<div class='qr-print-card'><div class='qr-container-relative'><div id='pqr-${s.id}' class='qr-wrapper'></div><div class='qr-logo-container'><img src='logo.png' class='qr-logo-img' onerror='this.style.display="none"'><span class='qr-logo-id'>${s.id}</span></div></div></div>`; html += `</div>`; } area.innerHTML = html; for (const s of list) { const el = document.getElementById(`pqr-${s.id}`); if(el) await generateQRAsync(el, s.id, 280); } setTimeout(() => { window.print(); document.getElementById('custom-modal').classList.add('hidden'); document.getElementById('print-area').style.display = ''; window.logAction(`Impresión QR ${logTag}`); }, 1200); }
        async function generateQRAsync(c, t, s) { return new Promise((r) => { new QRCode(c, { text: t, width: s, height: s, correctLevel : QRCode.CorrectLevel.H }); setTimeout(r, 150); }); }

        window.editStudent = (id) => {
            const student = students.find(s => s.id === id); if (!student) return;
            const container = document.getElementById('edit-modal-body');
            container.innerHTML = `<div><label class='text-[9px] font-black uppercase'>ID</label><input id='edit-id' type='text' value='${student.id}' class='w-full px-4 py-2 border rounded-lg uppercase'></div><div><label class='text-[9px] font-black uppercase'>Nombre</label><input id='edit-nombre' type='text' value='${student.nombre}' class='w-full px-4 py-2 border rounded-lg uppercase'></div>`;
            document.getElementById('btn-save-edit').onclick = () => saveStudentEdit(id); document.getElementById('edit-modal').classList.remove('hidden');
        };
        async function saveStudentEdit(oldId) {
            const newId = document.getElementById('edit-id').value.trim().toUpperCase(), nombre = document.getElementById('edit-nombre').value.trim().toUpperCase();
            if (!newId || !nombre) return;
            try {
                if (newId !== oldId) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', newId), { nombre, createdAt: serverTimestamp() }); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', oldId)); }
                else { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', oldId), { nombre }); }
                window.closeEditModal(); await loadStudents();
            } catch(e) {}
        }
        window.editTeacher = (id) => {
            const t = teachers.find(x => x.id === id); if (!t) return;
            const container = document.getElementById('edit-modal-body');
            container.innerHTML = `<div><label class='text-[9px] font-black uppercase'>ID</label><input id='edit-maestro-id' type='text' value='${t.id}' class='w-full px-4 py-2 border rounded-lg uppercase'></div><div><label class='text-[9px] font-black uppercase'>Nombre</label><input id='edit-maestro-nombre' type='text' value='${t.nombre}' class='w-full px-4 py-2 border rounded-lg uppercase'></div><label class='flex items-center gap-2 mt-2'><input id='edit-maestro-admin' type='checkbox' ${t.esAdmin?'checked':''}> <span class='text-[10px] font-black uppercase'>Admin</span></label>`;
            document.getElementById('btn-save-edit').onclick = () => saveTeacherEdit(id); document.getElementById('edit-modal').classList.remove('hidden');
        };
        async function saveTeacherEdit(oldId) {
            const newId = document.getElementById('edit-maestro-id').value.trim().toUpperCase(), nombre = document.getElementById('edit-maestro-nombre').value.trim().toUpperCase(), esAdmin = document.getElementById('edit-maestro-admin').checked;
            if (!newId || !nombre) return;
            try {
                const data = { nombre, esAdmin };
                if (newId !== oldId) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', newId), data); await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', oldId)); }
                else { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', oldId), data); }
                window.closeEditModal(); await loadTeachers();
            } catch(e) {}
        }
        window.confirmDeleteStudent = (id, name) => window.showModalMsg("Borrar Alumno", `¿Desea eliminar a ${name}?`, async () => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'alumnos', id)); loadStudents(); }, true);
        window.confirmDeleteTeacher = (id, name) => window.showModalMsg("Borrar Maestro", `¿Desea eliminar a ${name}?`, async () => { if(id===loggedTeacher.id) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'maestros', id)); loadTeachers(); }, true);

        initializeApplication();
    </script>
</body>
</html>