<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SGE QR - Sistema Global Escolar</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0e5b2f;
            --accent: #e96925;
        }

        .bg-school { background-color: var(--primary); }
        .text-school { color: var(--primary); }
        .border-school { border-color: var(--primary); }

        @page { size: letter; margin: 0; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; visibility: visible !important; }
            #print-area { position: absolute; left: 0; top: 0; width: 215.9mm; height: 279.4mm; z-index: 9999; background: white; padding: 5mm; box-sizing: border-box; }
            .qr-grid { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; width: 205.9mm !important; gap: 0 !important; margin: 0 auto !important; }
            .qr-print-card { display: flex !important; flex-direction: column; justify-content: center; align-items: center; border: 0.1mm solid #ddd; padding: 4mm; overflow: hidden; }
            .page-break { page-break-after: always; }
        }

        .tab-active { border-bottom: 4px solid var(--primary); color: var(--primary); font-weight: bold; }
        .subtab-active { background-color: var(--primary) !important; color: white !important; }
        
        .setup-step { display: none; }
        .setup-step.active { display: block; animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input[type="time"], input[type="number"] { text-align: center; font-weight: 700; }
        .scroll-custom::-webkit-scrollbar { width: 6px; }
        .scroll-custom::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 font-sans text-xs">

    <!-- MODAL MENSAJES -->
    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[800] hidden flex items-center justify-center p-4 text-center">
        <div class="bg-white rounded-[2rem] shadow-2xl max-w-sm w-full p-8 space-y-4 border-t-8 border-school">
            <h3 id="modal-msg-title" class="text-lg font-black text-school uppercase">Aviso</h3>
            <p id="modal-msg-body" class="text-sm text-slate-600 font-medium"></p>
            <div id="modal-msg-footer" class="flex gap-2 pt-4">
                <button id="btn-modal-confirm" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg active:scale-95 transition-transform">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- GATEWAY (ACCESO ESCUELA) -->
    <section id="section-gateway" class="fixed inset-0 bg-school z-[400] overflow-y-auto p-4 flex flex-col justify-center items-center text-center">
        <div class="bg-white p-8 md:p-10 rounded-[3rem] shadow-2xl max-w-lg w-full space-y-8 border-t-[12px] border-orange-500 relative">
            
            <div id="step-school-key" class="setup-step active space-y-6">
                <div class="space-y-2 text-center">
                    <i class="fas fa-key text-4xl text-orange-500"></i>
                    <h1 class="text-2xl font-black text-school uppercase tracking-tight">Acceso Institucional</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Ingrese la clave única de su escuela</p>
                </div>
                <input id="input-school-key" type="text" placeholder="CLAVE DE ESCUELA" class="w-full px-4 py-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-center text-xl font-black uppercase shadow-inner">
                <button onclick="window.validateSchoolKey()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-widest active:scale-95">Validar Escuela</button>
            </div>

            <div id="step-school-register" class="setup-step space-y-6">
                <div class="space-y-2">
                    <i class="fas fa-plus-circle text-4xl text-school"></i>
                    <h2 class="text-xl font-black text-school uppercase">Nueva Escuela</h2>
                    <p class="text-[10px] text-amber-600 font-black uppercase italic">Configure al Administrador Maestro:</p>
                </div>
                <div class="space-y-4">
                    <input id="input-new-school-name" type="text" placeholder="NOMBRE DE LA ESCUELA" class="w-full px-4 py-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-center font-bold uppercase shadow-sm">
                    
                    <div class="bg-blue-50 p-6 rounded-[2rem] border border-dashed border-blue-200 space-y-3">
                        <i class="fas fa-user-shield text-blue-500 text-2xl"></i>
                        <h3 class="text-[10px] font-black text-blue-800 uppercase tracking-tighter">Administrador Maestro</h3>
                        <p class="text-[9px] text-blue-600 leading-tight italic text-center">Su primer acceso será con el ID: <span class="font-black text-blue-800">123</span></p>
                        <input id="input-admin-name" type="text" placeholder="NOMBRE COMPLETO" class="w-full px-4 py-2 border border-blue-100 rounded-xl uppercase font-bold outline-none text-center">
                    </div>
                </div>
                <button onclick="window.registerSchoolAndAdmin()" class="w-full bg-school text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-widest active:scale-95">Dar de Alta Institución</button>
                <button onclick="window.resetGateway()" class="text-[9px] text-slate-400 font-bold uppercase underline">Volver</button>
            </div>

            <div id="step-login" class="setup-step space-y-6">
                <div class="p-6 bg-slate-50 rounded-[2rem] border border-slate-100">
                    <p id="display-school-name" class="text-base font-black text-school uppercase tracking-tighter">--</p>
                    <p id="display-school-key" class="text-[9px] text-slate-400 font-mono tracking-tighter italic">--</p>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Credencial Personal</label>
                    <input id="input-login-id" type="text" placeholder="SU ID PERSONAL" class="w-full px-4 py-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-center text-2xl font-black uppercase transition-all shadow-inner">
                </div>
                <button id="btn-login" onclick="window.attemptLogin()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-widest active:scale-95 text-center">Entrar al Sistema</button>
                <button onclick="window.resetGateway()" class="text-[9px] text-slate-400 font-bold uppercase underline">Cambiar Escuela</button>
            </div>
        </div>
    </section>

    <!-- CAMBIO ID OBLIGATORIO -->
    <div id="forced-id-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[600] hidden flex items-center justify-center p-4 text-center">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl max-w-sm w-full space-y-6 border-t-[12px] border-orange-500 animate-fadeIn text-center">
            <i class="fas fa-shield-alt text-6xl text-orange-500"></i>
            <div class="space-y-2">
                <h2 class="text-xl font-black text-school uppercase">Personalizar Acceso</h2>
                <p class="text-xs text-slate-500 font-medium leading-relaxed">Ha ingresado con el ID temporal. <br><span class="font-black text-orange-600 italic">Debe personalizar su identificación</span> para administrar la escuela.</p>
            </div>
            <div class="space-y-4">
                <input id="input-forced-new-id" type="text" placeholder="NUEVO ID PERSONAL" class="w-full px-4 py-4 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-center text-xl font-black uppercase shadow-inner">
                <button onclick="window.updateTeacherForcedId()" class="w-full bg-orange-600 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-transform uppercase tracking-widest text-[10px]">Actualizar mi Acceso</button>
            </div>
        </div>
    </div>

    <!-- CONFIGURACIÓN DE TIEMPOS -->
    <section id="section-user-setup" class="fixed inset-0 bg-slate-200 z-[350] hidden overflow-y-auto p-4 flex flex-col items-center justify-center text-center">
        <div class="max-w-md w-full bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-300 border-t-[12px] border-school flex flex-col max-h-[95vh]">
            <div class="bg-slate-50 p-6 text-center border-b flex-shrink-0">
                <i class="fas fa-clock text-3xl text-school mb-2"></i>
                <h2 class="text-lg font-black text-school uppercase tracking-tight">Configuración Escolar</h2>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Defina sus parámetros de jornada</p>
            </div>
            
            <div class="p-8 space-y-8 overflow-y-auto scroll-custom flex-1 text-left">
                <div class="space-y-6">
                    <h3 class="text-[10px] font-black text-school uppercase border-b pb-1 tracking-tighter italic">Parámetros de Puntualidad</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase text-center block">Hora Entrada</label>
                            <input id="setup-entry-time" type="time" value="08:00" class="w-full px-3 py-3 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-sm">
                        </div>
                        <div class="space-y-1 text-center">
                            <label class="text-[9px] font-black text-slate-400 uppercase block">Límite Retardo (m)</label>
                            <input id="setup-lateness-threshold" type="number" value="10" class="w-full px-3 py-3 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1 text-center">
                            <label class="text-[9px] font-black text-slate-400 uppercase block">Duración de clase (m)</label>
                            <input id="setup-class-duration" type="number" value="50" class="w-full px-3 py-3 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-sm text-center">
                        </div>
                        <div class="space-y-1 text-center">
                            <label class="text-[9px] font-black text-slate-400 uppercase block">Regreso del recreo</label>
                            <input id="setup-recess-return" type="time" value="10:30" class="w-full px-3 py-3 border-2 border-slate-100 rounded-2xl outline-none focus:border-orange-500 text-sm text-center">
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-50 border-t flex-shrink-0 text-center">
                <button onclick="window.saveUserConfig()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-black py-4 rounded-2xl shadow-xl uppercase tracking-widest active:scale-95 transition-all text-xs">Guardar y Aceptar Configuración</button>
            </div>
        </div>
    </section>

    <!-- UI DE LA APP (HEADER) -->
    <header id="main-header" class="bg-white shadow-sm no-print hidden border-b border-slate-100 sticky top-0 z-[100] text-center">
        <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4 text-center">
            <div class="flex items-center gap-4 text-left">
                <div class="flex flex-col">
                    <h1 id="header-school-name" class="text-xl font-black uppercase text-school leading-none tracking-tighter">--</h1>
                    <div class="flex gap-2 items-center justify-center md:justify-start mt-1">
                        <span id="user-display-name" class="text-[10px] font-black text-slate-700 uppercase tracking-tight">--</span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <span id="user-display-role" class="text-[9px] text-orange-600 font-bold uppercase italic italic tracking-tight">--</span>
                    </div>
                </div>
            </div>
            <nav class="flex gap-1 bg-slate-100 p-1 rounded-2xl items-center shadow-inner justify-center">
                <button onclick="window.switchTab('scanner')" id="tab-scanner" class="px-5 py-2.5 rounded-xl transition-all text-[10px] font-black uppercase"><i class="fas fa-camera mr-2"></i>Escanear</button>
                <button onclick="window.switchTab('admin')" id="tab-admin" class="px-5 py-2.5 rounded-xl transition-all text-[10px] font-black uppercase hidden"><i class="fas fa-users-cog mr-2"></i>Control Escolar</button>
                <div class="h-6 w-px bg-slate-300 mx-2"></div>
                <button onclick="window.openUserSetup()" class="p-2.5 text-slate-400 hover:text-school transition-colors" title="Ajustes de Horario"><i class="fas fa-cog"></i></button>
                <button onclick="window.logout()" class="p-2.5 text-red-400 hover:text-red-600 transition-colors"><i class="fas fa-power-off"></i></button>
            </nav>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="max-w-6xl mx-auto p-4 md:p-8 no-print hidden text-center">
        
        <!-- SECCIÓN ESCÁNER -->
        <section id="section-scanner" class="space-y-8 animate-fadeIn text-center">
            <div class="max-w-md mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-200">
                <div class="bg-school p-6 text-white text-center">
                    <h2 class="text-lg font-black uppercase tracking-wide">Pase de Lista</h2>
                    <p id="current-schedule-label" class="text-[9px] opacity-80 uppercase font-black italic mt-1 tracking-widest text-center">Sincronizando...</p>
                </div>
                <div class="p-8 space-y-6">
                    <div id="qr-reader" class="rounded-[2.5rem] overflow-hidden border-4 border-dashed border-slate-100 bg-slate-50 min-h-[320px]"></div>
                    <button onclick="window.toggleCamera()" id="btn-camera" class="w-full bg-slate-800 hover:bg-black text-white font-black py-5 rounded-[2rem] shadow-xl uppercase text-[10px] transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-sync-alt"></i> <span id="btn-camera-text">Apagar Cámara</span>
                    </button>
                    <div class="bg-slate-50 p-6 rounded-[2rem] border border-slate-200 shadow-inner">
                        <div class="flex gap-3">
                            <input id="input-manual-id" type="text" placeholder="ID ALUMNO" class="flex-1 px-4 py-3 border-2 border-slate-100 rounded-2xl uppercase text-sm font-black outline-none focus:ring-2 focus:ring-orange-500 shadow-sm">
                            <button onclick="window.manualAttendance()" class="bg-orange-600 text-white px-8 py-3 rounded-2xl text-xs font-black uppercase shadow-lg active:scale-95 transition-all text-center">OK</button>
                        </div>
                    </div>
                    <div id="scan-status" class="p-5 rounded-2xl text-center font-black hidden uppercase text-[10px] shadow-sm"></div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden max-w-2xl mx-auto shadow-xl text-left">
                <div class="px-8 py-5 bg-slate-50 border-b flex justify-between items-center">
                    <h3 class="font-black text-[10px] uppercase text-school tracking-widest font-mono italic">Registros Recientes</h3>
                    <span id="scan-count" class="bg-orange-100 text-orange-700 text-[10px] font-black px-5 py-1.5 rounded-full uppercase italic tracking-tighter">0 HOY</span>
                </div>
                <ul id="recent-logs" class="divide-y divide-slate-100 max-h-96 overflow-y-auto">
                    <li class="p-14 text-center text-slate-400 italic">No hay registros hoy...</li>
                </ul>
            </div>
        </section>

        <!-- SECCIÓN ADMINISTRACIÓN -->
        <section id="section-admin" class="hidden space-y-8 animate-fadeIn text-left text-center">
            <div id="admin-tabs" class="flex flex-wrap gap-2 border-b border-slate-200 pb-4 justify-center md:justify-start">
                <button onclick="window.switchSubTab('asistencia')" id="subtab-asistencia" class="px-4 py-2 rounded-xl bg-white border text-[10px] font-black uppercase text-slate-600 transition-all">Reportes</button>
                <button onclick="window.switchSubTab('mantenimiento')" id="subtab-mantenimiento" class="px-4 py-2 rounded-xl bg-white border text-[10px] font-black uppercase text-school transition-all">Mantenimiento</button>
                <button onclick="window.switchSubTab('historial')" id="subtab-historial" class="hidden px-4 py-2 rounded-xl bg-white border text-[10px] font-black uppercase text-indigo-600 transition-all">Bitácora</button>
            </div>

            <div id="subcontent-mantenimiento" class="hidden space-y-6 text-center md:text-left">
                <div class="flex flex-wrap gap-4 border-b border-slate-200 pb-2 justify-center md:justify-start text-center">
                    <button onclick="window.switchMaintCategory('alumnos')" id="maint-cat-alumnos" class="maint-cat-btn pb-2 px-4 text-[10px] font-black uppercase border-b-2 border-transparent transition-all">Catálogo Alumnos</button>
                    <button onclick="window.switchMaintCategory('maestros')" id="maint-cat-maestros" class="maint-cat-btn pb-2 px-4 text-[10px] font-black uppercase border-b-2 border-transparent transition-all">Gestión Personal</button>
                    <button onclick="window.switchMaintCategory('institucion')" id="maint-cat-institucion" class="maint-cat-btn pb-2 px-4 text-[10px] font-black uppercase border-b-2 border-transparent transition-all text-orange-600 hidden">Institución</button>
                </div>

                <div id="div-migracion-alerta" class="hidden bg-amber-50 p-6 rounded-[2rem] border-2 border-dashed border-amber-200 text-center space-y-3">
                    <i class="fas fa-history text-3xl text-amber-500"></i>
                    <h3 class="text-sm font-black text-amber-800 uppercase italic">Rescate de Datos</h3>
                    <button onclick="window.migrateXochicalliData()" class="bg-amber-500 text-white px-6 py-2 rounded-xl font-bold uppercase shadow-md active:scale-95 transition-all text-[10px]">Migrar Historial Xochicalli</button>
                </div>

                <!-- GESTIÓN INSTITUCIÓN -->
                <div id="div-mantenimiento-institucion" class="hidden animate-fadeIn space-y-6 text-center">
                    <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 max-w-xl mx-auto space-y-6 shadow-xl text-left">
                        <h3 class="font-black text-school uppercase text-center border-b pb-2 tracking-tighter">Panel de la Institución</h3>
                        <div class="space-y-4">
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase ml-2 text-center block">Nombre de la Escuela</label>
                                <input id="edit-school-name" type="text" class="w-full px-4 py-3 border-2 border-slate-50 rounded-2xl uppercase font-bold outline-none focus:border-school shadow-sm text-center">
                            </div>
                            <div class="space-y-1 text-center">
                                <label class="text-[9px] font-black text-slate-400 uppercase block">Clave Única (Protegida)</label>
                                <input id="display-school-key-readonly" type="text" readonly class="w-full px-4 py-3 border border-slate-100 rounded-2xl uppercase font-black bg-slate-50 opacity-60 text-slate-400 cursor-not-allowed text-center">
                            </div>
                            <button onclick="window.updateSchoolGlobalData()" class="w-full bg-school text-white font-black py-4 rounded-2xl uppercase shadow-lg active:scale-95 transition-all text-[10px]">Actualizar Datos</button>
                        </div>
                    </div>
                </div>

                <!-- ALTA MAESTROS -->
                <div id="div-mantenimiento-maestros" class="hidden animate-fadeIn space-y-6">
                    <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 max-w-xl mx-auto space-y-4 shadow-xl text-left">
                        <h3 class="font-black text-school uppercase text-center border-b pb-2 tracking-tighter italic">Alta de Personal y Roles</h3>
                        <div class="space-y-4 text-center">
                            <input id="input-m-name" type="text" placeholder="NOMBRE COMPLETO" class="w-full px-4 py-3 border-2 border-slate-50 rounded-2xl uppercase font-bold outline-none focus:border-school shadow-sm text-center">
                            <div class="grid grid-cols-2 gap-4">
                                <input id="input-m-id" type="text" placeholder="ID TEMPORAL" class="w-full px-4 py-3 border-2 border-slate-50 rounded-2xl uppercase font-black outline-none focus:border-school shadow-sm">
                                <select id="input-m-role" class="w-full px-4 py-3 border-2 border-slate-50 rounded-2xl uppercase font-black outline-none focus:border-school bg-slate-50 text-center shadow-sm">
                                    <option value="profesor">PROFESOR</option>
                                    <option value="admin_sec">ADMIN SECUNDARIO</option>
                                    <option value="entrada">ENTRADA / PORTERÍA</option>
                                </select>
                            </div>
                            <button onclick="window.registerNewTeacher()" class="w-full bg-school text-white font-black py-4 rounded-2xl uppercase shadow-lg active:scale-95 transition-all text-[10px]">Registrar en Escuela</button>
                        </div>
                    </div>
                </div>

                <div id="div-mantenimiento-alumnos" class="hidden animate-fadeIn grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                    <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 space-y-4 shadow-lg text-left">
                        <h3 class="font-black text-school uppercase text-[10px] border-b pb-2">Captura Individual</h3>
                        <input id="input-a-id" type="text" placeholder="ID ALUMNO" class="w-full px-4 py-3 border rounded-2xl uppercase font-black outline-none focus:ring-1 focus:ring-school text-center">
                        <input id="input-a-name" type="text" placeholder="NOMBRE COMPLETO" class="w-full px-4 py-3 border rounded-2xl uppercase font-bold outline-none focus:ring-1 focus:ring-school text-center text-center">
                        <button onclick="window.addStudent()" class="w-full bg-school text-white font-black py-4 rounded-2xl uppercase text-[10px] shadow-lg active:scale-95 transition-transform">Guardar Registro</button>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 text-center shadow-lg flex flex-col justify-center">
                        <i class="fas fa-file-import text-3xl text-slate-300 mb-3"></i>
                        <h3 class="font-black text-school uppercase text-[10px] border-b pb-2 mb-3 tracking-tighter">Carga Masiva (CSV)</h3>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
                        <button onclick="document.getElementById('csv-file-input').click()" class="w-full bg-slate-50 text-slate-600 py-4 rounded-2xl border border-slate-200 font-black uppercase text-[10px] hover:bg-slate-100">Importar Archivo</button>
                    </div>
                </div>

                <div id="general-table-container" class="bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden shadow-2xl hidden animate-fadeIn text-left text-center">
                    <div class="px-8 py-5 bg-slate-50 border-b flex flex-col md:flex-row justify-between items-center gap-4 text-left">
                        <h3 id="table-title-text" class="font-black text-school uppercase text-xs tracking-widest font-mono italic text-center">REGISTROS</h3>
                        <div class="relative w-full md:w-1/2">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" id="record-search-input" placeholder="BUSCAR..." onkeyup="window.handleRecordSearch()" class="w-full pl-10 pr-6 py-3 border border-slate-200 rounded-2xl text-[10px] uppercase font-black outline-none focus:ring-1 focus:ring-orange-500 shadow-inner">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead id="table-headers" class="bg-slate-50 text-slate-400 text-[9px] font-black uppercase border-b text-center"></thead>
                            <tbody id="data-table-body" class="divide-y divide-slate-100 text-[10px] font-bold uppercase tracking-tight text-center"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="subcontent-asistencia" class="hidden space-y-6 animate-fadeIn">
                 <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 flex flex-wrap gap-6 items-end shadow-lg text-left">
                    <div class="flex-1 min-w-[150px] text-center"><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Desde</label><input id="date-from" type="date" class="w-full px-4 py-3 border rounded-2xl text-xs outline-none"></div>
                    <div class="flex-1 min-w-[150px] text-center"><label class="text-[9px] font-black uppercase text-slate-400 block mb-1">Hasta</label><input id="date-to" type="date" class="w-full px-4 py-3 border rounded-2xl text-xs outline-none"></div>
                    <button onclick="window.generateAttendanceReport()" class="bg-school text-white font-black px-8 py-3.5 rounded-2xl text-xs uppercase shadow-xl hover:opacity-90 active:scale-95 transition-all text-center">Generar Reporte</button>
                </div>
                <div id="attendance-report-container" class="hidden bg-white p-8 rounded-[3rem] border border-slate-200 shadow-2xl text-left animate-fadeIn">
                    <div class="flex justify-between items-center mb-6 text-center">
                        <h2 class="font-black text-school uppercase text-xl">Reporte de Asistencia</h2>
                        <button onclick="window.printAttendanceReport()" class="bg-slate-800 text-white px-6 py-2.5 rounded-xl text-[10px] font-black uppercase hover:bg-black transition-colors"><i class="fas fa-print mr-2"></i>Imprimir</button>
                    </div>
                    <div class="overflow-x-auto rounded-[2rem] border border-slate-100 text-center">
                        <table class="w-full text-left border-collapse">
                            <thead id="report-table-head" class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase border-b text-center"></thead>
                            <tbody id="report-table-body" class="divide-y divide-slate-100 text-[10px] font-bold text-center"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="subcontent-historial" class="hidden space-y-6 text-left animate-fadeIn">
                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-xl flex justify-between items-center text-left">
                    <div class="space-y-1 text-center md:text-left">
                        <h3 class="font-black text-indigo-900 uppercase text-sm font-mono tracking-tighter">Bitácora Global</h3>
                        <p class="text-[9px] text-slate-400 font-bold uppercase italic tracking-widest">Auditoría institucional de acciones</p>
                    </div>
                    <button onclick="window.confirmResetHistory()" class="bg-red-50 text-red-600 px-6 py-2 rounded-xl text-[10px] font-black uppercase border border-red-100 active:scale-95 transition-all">Limpiar Log</button>
                </div>
                <div class="bg-white rounded-[2.5rem] border border-slate-200 overflow-hidden shadow-2xl text-left">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-400 text-[9px] font-black uppercase border-b text-center">
                            <tr><th class="px-8 py-4 border-b">Fecha / Hora</th><th class="px-8 py-4 border-b">Usuario</th><th class="px-8 py-4 border-b text-center">Acción</th></tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-slate-100 text-xs font-semibold text-slate-600 text-center"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, query, where, deleteDoc, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCXkAb_YnMSOcww5D6RQPMd56BSdCwkiB8",
            authDomain: "listadeasitencia.firebaseapp.com",
            projectId: "listadeasitencia",
            storageBucket: "listadeasitencia.firebasestorage.app",
            messagingSenderId: "379159619523",
            appId: "1:379159619523:web:7aeb44a8bdc6d24bdd3f76"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        const auth = getAuth(fbApp);

        let schoolKey = "", schoolName = "";
        let currentUser = null, loggedTeacher = null, currentSubTab = 'asistencia';
        let students = [], teachers = [], scannedTodayIds = new Set();
        let html5QrScanner = null, isScannerRunning = false, isScannerTransitioning = false;
        let audioCtx = null;
        let currentMaintCat = 'alumnos';

        const getColl = (name) => collection(db, 'artifacts', 'listadeasitencia', 'public', 'data', `${schoolKey}_${name}`);
        const getDocRef = (coll, id) => doc(db, 'artifacts', 'listadeasitencia', 'public', 'data', `${schoolKey}_${coll}`, id);

        /* --- VINCULACIÓN GLOBAL --- */
        window.getMexicoDate = () => new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Mexico_City' }).format(new Date());
        window.getMexicoTime = () => new Intl.DateTimeFormat('es-MX', { timeZone: 'America/Mexico_City', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).format(new Date());
        window.initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
        window.playSuccessSound = () => { window.initAudio(); const t = audioCtx.currentTime; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.setValueAtTime(880, t); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.7, t + 0.05); g.gain.linearRampToValueAtTime(0, t + 0.15); o.start(t); o.stop(t + 0.15); };
        window.playErrorSound = () => { window.initAudio(); const t = audioCtx.currentTime; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(120, t); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.7, t + 0.1); g.gain.linearRampToValueAtTime(0, t + 0.4); o.start(t); o.stop(t + 0.4); };

        window.showModalMsg = (title, message, callback = null) => {
            const modal = document.getElementById('custom-modal'); if(!modal) return;
            const titleEl = document.getElementById('modal-msg-title'), bodyEl = document.getElementById('modal-msg-body');
            if(titleEl) titleEl.innerText = title; if(bodyEl) bodyEl.innerText = message;
            modal.classList.remove('hidden');
            document.getElementById('btn-modal-confirm').onclick = () => { modal.classList.add('hidden'); if(callback) callback(); };
        };

        window.showStatus = (m, y) => {
            const e = document.getElementById('scan-status'); if (!e) return;
            e.innerText = m; e.className = `p-5 rounded-[2rem] text-center font-black block shadow-lg ${y === 'success' ? 'bg-green-50 text-green-700 border border-green-100' : (y === 'warning' ? 'bg-amber-50 text-amber-700 border border-amber-100' : 'bg-red-50 text-red-700 border border-red-100')}`;
            e.classList.remove('hidden');
        };

        window.logAction = async (description) => {
            if (!loggedTeacher || !schoolKey) return;
            try { await addDoc(getColl('historial'), { usuario: loggedTeacher.nombre, usuarioId: loggedTeacher.id, fecha: window.getMexicoDate(), hora: window.getMexicoTime(), descripcion, timestamp: serverTimestamp() }); } catch (e) {}
        };

        /* --- GATEWAY --- */
        window.resetGateway = () => {
            document.querySelectorAll('.setup-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step-school-key')?.classList.add('active');
        };

        window.validateSchoolKey = async () => {
            const key = document.getElementById('input-school-key').value.trim().toUpperCase();
            if (!key) return window.showModalMsg("Aviso", "Ingrese la clave única de su escuela.");
            schoolKey = key;
            try {
                const schoolDoc = await getDoc(doc(db, 'artifacts', 'listadeasitencia', 'public', 'data', 'colegios', schoolKey));
                if (schoolDoc.exists()) {
                    schoolName = schoolDoc.data().name;
                    document.getElementById('display-school-name').innerText = schoolName;
                    document.getElementById('display-school-key').innerText = `ID: ${schoolKey}`;
                    document.querySelectorAll('.setup-step').forEach(s => s.classList.remove('active'));
                    document.getElementById('step-login')?.classList.add('active');
                } else {
                    document.querySelectorAll('.setup-step').forEach(s => s.classList.remove('active'));
                    document.getElementById('step-school-register')?.classList.add('active');
                }
            } catch (e) { window.showModalMsg("Error", "Problema al verificar la escuela."); }
        };

        window.registerSchoolAndAdmin = async () => {
            const schName = document.getElementById('input-new-school-name').value.trim().toUpperCase();
            const admName = document.getElementById('input-admin-name').value.trim().toUpperCase();
            if (!schName || !admName) return window.showModalMsg("Aviso", "Datos incompletos.");
            try {
                await setDoc(doc(db, 'artifacts', 'listadeasitencia', 'public', 'data', 'colegios', schoolKey), { name: schName, createdAt: serverTimestamp() });
                await setDoc(getDocRef('maestros', '123'), { nombre: admName, esAdmin: true, configDone: false, idCambiado: false, role: 'admin_maestro' });
                schoolName = schName;
                window.showModalMsg("Éxito", "Institución registrada. El administrador debe entrar con el ID 123.", () => window.validateSchoolKey());
            } catch (e) { window.showModalMsg("Error", "Error al crear institución."); }
        };

        /* --- LOGIN Y SEGURIDAD --- */
        window.attemptLogin = async () => {
            const idInput = document.getElementById('input-login-id').value.trim().toUpperCase();
            if (!idInput) return window.showModalMsg("Aviso", "Ingrese su ID.");
            const btn = document.getElementById('btn-login'); btn.disabled = true;
            try {
                const tSnap = await getDoc(getDocRef('maestros', idInput));
                if (tSnap.exists()) {
                    loggedTeacher = { id: tSnap.id, ...tSnap.data() };
                    if (!loggedTeacher.idCambiado) {
                        document.getElementById('section-gateway').classList.add('hidden');
                        document.getElementById('forced-id-modal').classList.remove('hidden');
                    } else if (!loggedTeacher.configDone) {
                        window.openUserSetup();
                    } else { enterApp(); }
                } else {
                    if (idInput === 'TLAHUISCALPANTECUTLI') { 
                        loggedTeacher = { id: idInput, nombre: 'SUPERUSUARIO', esAdmin: true, configDone: true, idCambiado: true, role: 'super' };
                        enterApp();
                    } else { window.showModalMsg("Denegado", "ID no registrado."); }
                }
            } catch (e) { window.showModalMsg("Error", "Fallo de conexión."); }
            finally { btn.disabled = false; }
        };

        window.updateTeacherForcedId = async () => {
            const newId = document.getElementById('input-forced-new-id').value.trim().toUpperCase();
            if(!newId || newId === "123") return window.showModalMsg("Aviso", "Ingrese un ID nuevo diferente.");
            try {
                const checkDoc = await getDoc(getDocRef('maestros', newId));
                if(checkDoc.exists()) return window.showModalMsg("Error", "Este ID ya existe.");
                const oldId = loggedTeacher.id;
                const newData = { ...loggedTeacher, idCambiado: true };
                await setDoc(getDocRef('maestros', newId), newData);
                await deleteDoc(getDocRef('maestros', oldId));
                loggedTeacher.id = newId; loggedTeacher.idCambiado = true;
                document.getElementById('forced-id-modal').classList.add('hidden');
                window.openUserSetup();
            } catch(e) { window.showModalMsg("Error", "Fallo al actualizar acceso."); }
        };

        /* --- CONFIGURACIÓN TIEMPOS --- */
        window.openUserSetup = () => {
            document.getElementById('section-gateway').classList.add('hidden');
            document.getElementById('section-user-setup').classList.remove('hidden');
            if(loggedTeacher.configDone) {
                document.getElementById('setup-entry-time').value = loggedTeacher.entryTime || "08:00";
                document.getElementById('setup-class-duration').value = loggedTeacher.classDuration || "50";
                document.getElementById('setup-lateness-threshold').value = loggedTeacher.latenessThreshold || "10";
                document.getElementById('setup-recess-return').value = loggedTeacher.recessReturn || "10:30";
            }
        };

        window.saveUserConfig = async () => {
            const config = {
                entryTime: document.getElementById('setup-entry-time').value,
                classDuration: document.getElementById('setup-class-duration').value,
                latenessThreshold: document.getElementById('setup-lateness-threshold').value,
                recessReturn: document.getElementById('setup-recess-return').value,
                configDone: true
            };
            if (!config.entryTime || !config.classDuration) return window.showModalMsg("Aviso", "Complete los campos requeridos.");
            try {
                await setDoc(getDocRef('maestros', loggedTeacher.id), config, { merge: true });
                loggedTeacher = { ...loggedTeacher, ...config };
                document.getElementById('section-user-setup').classList.add('hidden');
                enterApp();
                await window.logAction("Sincronización de horarios completada.");
            } catch (e) { window.showModalMsg("Error", "Fallo al sincronizar con Firebase."); }
        };

        /* --- DASHBOARD CORE --- */
        function enterApp() {
            document.getElementById('section-gateway').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('header-school-name').innerText = schoolName;
            document.getElementById('user-display-name').innerText = loggedTeacher.nombre;
            
            const isSuper = loggedTeacher.id === 'TLAHUISCALPANTECUTLI';
            const isAdminMaestro = loggedTeacher.role === 'admin_maestro';
            const isAdminSec = loggedTeacher.role === 'admin_sec';
            const isEntrance = loggedTeacher.role === 'entrada';
            
            const isAdmin = isAdminMaestro || isAdminSec || isSuper;
            
            const roleStr = isSuper ? 'SUPERUSUARIO' : (isAdminMaestro ? 'ADMIN MAESTRO' : (isAdminSec ? 'ADMIN SECUNDARIO' : (isEntrance ? 'PORTERÍA' : 'DOCENTE')));
            document.getElementById('user-display-role').innerText = roleStr;
            document.getElementById('tab-admin').classList.toggle('hidden', !isAdmin);
            document.getElementById('maint-cat-institucion').classList.toggle('hidden', !isAdminMaestro && !isSuper);

            if(loggedTeacher.configDone) document.getElementById('current-schedule-label').innerText = isEntrance ? "VIGILANCIA ACCESO" : `ENTRADA: ${loggedTeacher.entryTime} | CLASE: ${loggedTeacher.classDuration}m`;
            
            if(schoolKey === 'XOCHICALLI' && isAdminMaestro) document.getElementById('div-migracion-alerta').classList.remove('hidden');

            loadStudents(); loadTeachers(); listenToAttendanceToday(); window.switchTab('scanner');
        }

        window.logout = () => { location.reload(); };

        window.switchTab = async (t) => {
            document.getElementById('section-scanner').classList.toggle('hidden', t !== 'scanner');
            document.getElementById('section-admin').classList.toggle('hidden', t !== 'admin');
            if (t === 'scanner') await window.initScanner(); else { await window.stopScanner(); window.switchSubTab('asistencia'); }
        };

        window.switchSubTab = (s) => {
            currentSubTab = s;
            ['asistencia', 'mantenimiento', 'historial'].forEach(x => { document.getElementById('subcontent-' + x)?.classList.add('hidden'); document.getElementById('subtab-' + x)?.classList.remove('subtab-active'); });
            document.getElementById('subcontent-' + s)?.classList.remove('hidden');
            document.getElementById('subtab-' + s)?.classList.add('subtab-active');
            document.getElementById('general-table-container').classList.add('hidden');
            if (s === 'historial') window.listenToHistorial();
        };

        window.switchMaintCategory = (c) => {
            currentMaintCat = c;
            document.querySelectorAll('.maint-cat-btn').forEach(b => b.className = "maint-cat-btn pb-2 px-4 text-[10px] font-black uppercase border-b-2 border-transparent transition-all text-center");
            const act = document.getElementById('maint-cat-' + (c === 'institucion' ? 'institucion' : (c === 'alumnos' ? 'alumnos' : 'maestros'))); if(act) act.classList.add('cat-active');
            ['alumnos', 'maestros', 'institucion'].forEach(x => document.getElementById(`div-mantenimiento-${x}`)?.classList.add('hidden'));
            document.getElementById(`div-mantenimiento-${c}`)?.classList.remove('hidden');
            if(c === 'institucion') {
                document.getElementById('general-table-container').classList.add('hidden');
                document.getElementById('edit-school-name').value = schoolName;
                document.getElementById('display-school-key-readonly').value = schoolKey;
            } else { renderTable(c === 'alumnos' ? "catalog" : "teachers"); }
        };

        window.updateSchoolGlobalData = async () => {
            const newName = document.getElementById('edit-school-name').value.trim().toUpperCase();
            if(!newName) return window.showModalMsg("Aviso", "Nombre requerido.");
            try {
                await setDoc(doc(db, 'artifacts', 'listadeasitencia', 'public', 'data', 'colegios', schoolKey), { name: newName }, { merge: true });
                schoolName = newName; document.getElementById('header-school-name').innerText = schoolName;
                window.showModalMsg("Éxito", "Institución actualizada.");
            } catch(e) {}
        };

        /* --- DATA MANAGEMENT --- */
        async function loadStudents() { if(!schoolKey) return; const snap = await getDocs(getColl('alumnos')); students = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.nombre.localeCompare(b.nombre)); }
        async function loadTeachers() { if(!schoolKey) return; const snap = await getDocs(getColl('maestros')); teachers = snap.docs.map(d => ({ id: d.id, ...d.data() })); }

        function renderTable(mode, filterTerm = "") {
            const body = document.getElementById('data-table-body'), head = document.getElementById('table-headers');
            if(!body || !head) return; document.getElementById('general-table-container').classList.remove('hidden');
            if (mode === "catalog") {
                head.innerHTML = `<tr><th class='px-8 py-4 border-b text-center'>ID</th><th class='px-8 py-4 border-b text-center'>Nombre Alumno</th><th class='px-8 py-4 border-b text-center'>X</th></tr>`;
                const data = filterTerm ? students.filter(s => s.nombre.includes(filterTerm) || s.id.includes(filterTerm)) : students;
                body.innerHTML = data.map(s => `<tr><td class='px-8 py-4 font-black text-center'>${s.id}</td><td class='px-8 py-4 font-bold text-center'>${s.nombre}</td><td class='px-8 py-4 text-center'><button onclick='window.confirmDeleteStudent("${s.id}", "${s.nombre}")' class="text-red-400 hover:text-red-600"><i class='fas fa-trash-alt'></i></button></td></tr>`).join('');
            } else if (mode === "teachers") {
                head.innerHTML = `<tr><th class='px-8 py-4 border-b text-center'>ID</th><th class='px-8 py-4 border-b text-center'>Personal</th><th class='px-8 py-4 border-b text-center tracking-tighter'>Rol</th><th class='px-8 py-4 border-b text-center'>X</th></tr>`;
                const rawData = teachers.filter(t => t.id !== 'TLAHUISCALPANTECUTLI' && t.id !== '123' && t.id !== loggedTeacher.id);
                const data = filterTerm ? rawData.filter(t => t.nombre.includes(filterTerm) || t.id.includes(filterTerm)) : rawData;
                body.innerHTML = data.map(t => `<tr><td class='px-8 py-4 font-black text-center'>${t.idCambiado ? '<i class="fas fa-lock opacity-20 mr-2"></i>' : ''}${t.id}</td><td class='px-8 py-4 font-bold text-center'>${t.nombre}</td><td class='px-8 py-4 italic text-orange-600 tracking-tighter text-center uppercase font-black'>${t.role}</td><td class='px-8 py-4 text-center'><button onclick='window.confirmDeleteTeacher("${t.id}", "${t.nombre}")' class="text-red-400 hover:text-red-600"><i class='fas fa-trash-alt'></i></button></td></tr>`).join('');
            }
        }

        window.registerNewTeacher = async () => {
            const name = document.getElementById('input-m-name').value.trim().toUpperCase();
            const id = document.getElementById('input-m-id').value.trim().toUpperCase();
            const role = document.getElementById('input-m-role').value;
            if(!name || !id) return window.showModalMsg("Aviso", "Complete los datos.");
            try { 
                await setDoc(getDocRef('maestros', id), { nombre: name, role, esAdmin: role.includes('admin'), configDone: false, idCambiado: false });
                document.getElementById('input-m-name').value = ''; document.getElementById('input-m-id').value = '';
                await loadTeachers(); renderTable("teachers");
                window.showStatus("Personal registrado", "success");
            } catch(e) {}
        };

        window.addStudent = async () => {
            const id = document.getElementById('input-a-id').value.trim().toUpperCase();
            const nombre = document.getElementById('input-a-name').value.trim().toUpperCase();
            if (!id || !nombre) return;
            try { await setDoc(getDocRef('alumnos', id), { nombre, createdAt: serverTimestamp() }); document.getElementById('input-a-id').value = ''; document.getElementById('input-a-name').value = ''; await loadStudents(); renderTable("catalog"); window.showStatus("Guardado", "success"); } catch(e) {}
        };

        /* --- MOTOR ESCANEO --- */
        window.initScanner = async () => {
            if (isScannerRunning || isScannerTransitioning) return; isScannerTransitioning = true;
            if (!html5QrScanner) html5QrScanner = new Html5Qrcode("qr-reader");
            try { await html5QrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => window.processAttendance(t)); isScannerRunning = true; window.updateScannerUI(true); } 
            catch (err) {} finally { isScannerTransitioning = false; }
        };
        window.stopScanner = async () => { if (!isScannerRunning || isScannerTransitioning) return; isScannerTransitioning = true; try { await html5QrScanner.stop(); isScannerRunning = false; window.updateScannerUI(false); } catch (e) {} finally { isScannerTransitioning = false; } };
        window.toggleCamera = async () => { if (isScannerRunning) await window.stopScanner(); else await window.initScanner(); };
        window.updateScannerUI = (r) => { const b = document.getElementById('btn-camera-text'); if(b) b.innerText = r ? "Apagar Cámara" : "Encender Cámara"; };

        window.processAttendance = async (t) => {
            if (!currentUser || !loggedTeacher) return;
            const id = t.trim().toUpperCase(); const now = window.getMexicoTime();
            try {
                const snap = await getDoc(getDocRef('alumnos', id));
                if (snap.exists()) {
                    await addDoc(getColl('asistencias'), { alumnoId: id, nombre: snap.data().nombre, profesorId: loggedTeacher.id, profesorNombre: loggedTeacher.nombre, fecha: window.getMexicoDate(), hora: now, status: "A TIEMPO", timestamp: serverTimestamp() });
                    window.playSuccessSound(); window.showStatus(`OK: ${snap.data().nombre}`, "success");
                } else { window.playErrorSound(); window.showStatus("ID NO EXISTE", "error"); }
            } catch (e) {}
            setTimeout(() => document.getElementById('scan-status')?.classList.add('hidden'), 2000);
        };

        window.manualAttendance = () => {
            const input = document.getElementById('input-manual-id'); const val = input ? input.value.trim().toUpperCase() : "";
            if(val) { window.processAttendance(val); input.value = ''; }
        };

        function listenToAttendanceToday() { 
            if (!loggedTeacher || !schoolKey) return; 
            onSnapshot(getColl('asistencias'), (snap) => { 
                const today = window.getMexicoDate(); scannedTodayIds.clear(); 
                const allLogs = snap.docs.map(d => d.data()).filter(d => d.fecha === today);
                allLogs.filter(l => l.profesorId === loggedTeacher.id).forEach(l => scannedTodayIds.add(l.alumnoId)); 
                document.getElementById('scan-count').innerText = `${allLogs.length} HOY`; 
                const recentLogs = document.getElementById('recent-logs');
                recentLogs.innerHTML = allLogs.length === 0 ? '<li class="p-14 text-center text-slate-400 italic">Sin actividad</li>' : allLogs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 10).map(l => `<li class="p-5 flex justify-between bg-white border-l-4 border-emerald-500 text-center"><div><p class="font-black uppercase text-[10px] text-slate-700">${l.nombre}</p><p class="text-[8px] text-slate-400">ID: ${l.alumnoId}</p></div><div class="text-right font-mono font-black">${l.hora}</div></li>`).join(''); 
            }); 
        }

        window.listenToHistorial = function() {
            if (!currentUser || (loggedTeacher && loggedTeacher.id !== 'TLAHUISCALPANTECUTLI')) return;
            onSnapshot(getColl('historial'), (snap) => {
                const body = document.getElementById('history-table-body'); if(!body) return;
                const logs = snap.docs.map(d => d.data()).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                body.innerHTML = logs.map(l => `<tr><td class='px-8 py-4 font-mono text-center'>${l.fecha} ${l.hora}</td><td class='px-8 py-4 font-bold uppercase text-center'>${l.usuario}</td><td class='px-8 py-4 text-slate-500 text-center'>${l.descripcion}</td></tr>`).join('');
            });
        };

        window.initializeApplication = async () => {
            try { await signInAnonymously(auth); } catch (e) {}
            onAuthStateChanged(auth, u => { currentUser = u; if(u && document.getElementById('btn-login')) document.getElementById('btn-login').disabled = false; });
            const today = window.getMexicoDate();
            if(document.getElementById('date-from')) document.getElementById('date-from').value = today;
            if(document.getElementById('date-to')) document.getElementById('date-to').value = today;
        };

        window.confirmDeleteStudent = (id, name) => window.showModalMsg("Borrar", `¿Eliminar a ${name}?`, async () => { await deleteDoc(getDocRef('alumnos', id)); await loadStudents(); renderTable("catalog"); }, true);
        window.confirmDeleteTeacher = (id, name) => window.showModalMsg("Borrar", `¿Eliminar a ${name}?`, async () => { await deleteDoc(getDocRef('maestros', id)); await loadTeachers(); renderTable("teachers"); }, true);
        window.handleRecordSearch = () => { renderTable(currentMaintCat === 'alumnos' ? "catalog" : "teachers", document.getElementById('record-search-input').value.toUpperCase()); };
        window.printAttendanceReport = () => window.print();

        window.initializeApplication();
    </script>
</body>
</html>